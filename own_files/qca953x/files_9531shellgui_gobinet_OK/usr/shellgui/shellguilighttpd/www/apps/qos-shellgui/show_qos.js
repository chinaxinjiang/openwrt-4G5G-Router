function setBrowserTimeCookie(){var e=Math.floor((new Date).getTime()/1e3);document.cookie="browser_time="+e+"; path=/"}function getRequestObj(){var e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){return!1}}}return e}function runAjax(e,t,n,a){setBrowserTimeCookie();var o=getRequestObj();return o&&(o.onreadystatechange=function(){a(o)},"POST"==e?(n=null==n?" ":n,o.open("POST",t,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.send(n)):"GET"==e&&(o.open("GET",t+"?"+n,!0),o.send(null))),o}function getParameterDefinition(e,t){return encodeURIComponent(e)+"="+encodeURIComponent(t)}function parseBytes(e,t,n,a){var o;return t="KBytes"!=t&&"MBytes"!=t&&"GBytes"!=t&&"TBytes"!=t?"mixed":t,spcr=null==n||0==n?" ":"",o="mixed"==t&&e>1099511627776||"TBytes"==t?(e/1099511627776).toFixed(a||3)+spcr+(n?"TB":"TBy"):"mixed"==t&&e>1073741824||"GBytes"==t?(e/1073741824).toFixed(a||3)+spcr+(n?"GB":"GBy"):"mixed"==t&&e>1048576||"MBytes"==t?(e/1048576).toFixed(a||3)+spcr+(n?"MB":"MBy"):(e/1024).toFixed(a||3)+spcr+(n?"KB":"KBy")}function getSelectedValue(e,t){return t=null==t?document:t,null==t.getElementById(e)?void alert(UI.Err+": "+e+" "+UI.nex):(selectedIndex=t.getElementById(e).selectedIndex,selectedValue="",selectedIndex>=0&&(selectedValue=t.getElementById(e).options[t.getElementById(e).selectedIndex].value),selectedValue)}function initializePieCharts(){uploadClassIds=[],downloadClassIds=[],uploadClassNames=[],downloadClassNames=[];var e=[],t=[];for(monitorIndex=0;monitorIndex<monitorNames.length;monitorIndex++){var n=monitorNames[monitorIndex];if(n.match(/qos/)){var a=n.match(/up/),o=n.match(/down/),s=n.split("-");s.shift(),s.shift(),s.pop(),s.pop();var l=s.join("-"),r=uciOriginal.get("qos_shellgui",l,"name");a&&null==e[l]&&(uploadClassIds.push(l),uploadClassNames.push(r),e[l]=1),o&&null==t[l]&&(downloadClassIds.push(l),downloadClassNames.push(r),t[l]=1)}}uploadClassNames=formateLabel(uploadClassNames),downloadClassNames=formateLabel(downloadClassNames),initPieChart(uploadClassNames,downloadClassNames),setInterval(updatePieCharts,2e3)}function getMonitorId(e,t,n,a,o){var s,l=null,r="",d="";if("total"==n?r=o?"total"+t+"B":"total"+t+"A":n.match(/qos/)?(r="qos"+t,d=a):"ip"==n&&(r="bdist"+t),"none"!=n)for(s=0;s<monitorNames.length&&null==l;s++){var i=monitorNames[s];!(i.match("up")&&e||i.match("down")&&!e)||""!=r&&!i.match(r)||""!=d&&!i.match(d)||(l=i)}return l}function updatePieCharts(){if(!updateInProgress){updateInProgress=!0;var e=["up","down"],t=[];for(directionIndex=0;directionIndex<e.length;directionIndex++){var n=e[directionIndex],a="up"==n?uploadClassIds:downloadClassIds,o=parseInt(getSelectedValue(n+"_timeframe"));for(classIndex=0;classIndex<a.length;classIndex++)t.push(getMonitorId("up"==n,o,"qos",a[classIndex],!0))}var s=getParameterDefinition("monitor",t.join(" ")),l="app=qos-shellgui&action=get_bandwidth&"+s,r=function(e){if(4==e.readyState){var n=parseMonitors(e.responseText),a=["up","down"],o=[],s=[],l=[],r=[];for(directionIndex=0;directionIndex<a.length;directionIndex++){var d=a[directionIndex],i=[],u=0,c=[];for(nameIndex=0;nameIndex<t.length;nameIndex++)if(t[nameIndex].match(d)){var p=0,m=n[t[nameIndex]];if(null!=m){var h=m[0];p=parseInt(h[h.length-1])}i.push(p),u+=p}var I=0==u;if(I){var f;for(f=0;f<i.length;f++)i[f]=1,u++}for(nameIndex=0;nameIndex<i.length;nameIndex++){var x=d.match("up")?uploadClassNames:downloadClassNames;if(x=formateLabel(x),className=x[nameIndex],I){var v="("+truncateDecimal(100*(1/i.length))+"%)";c.push(className+" - "+parseBytes(i[nameIndex]-1,null,!0)+" "+v)}else{var v="("+truncateDecimal(100*i[nameIndex]/u)+"%)";c.push(className+"-"+parseBytes(i[nameIndex],null,!0)+"-"+v)}}o=d.match("up")?i:o,s=d.match("up")?c:s,l=d.match("down")?i:l,r=d.match("down")?c:r}updatePieChart(o,s,l,r),updateInProgress=!1}};runAjax("POST","/",l,r)}}function parseMonitors(e){var t=new Array,n=e.split("\n");parseInt(n.shift());for(lineIndex=0;lineIndex<n.length;lineIndex++)n[lineIndex].length>0&&(monitorName=n[lineIndex],monitorName=monitorName.replace(/[\t ]+.*$/,""),lineIndex++,lineIndex++,lineIndex++,lastTimePoint=n[lineIndex],lineIndex++,points=n[lineIndex].split(","),t[monitorName]=[points,lastTimePoint]);return t}function truncateDecimal(e){return result=""+Math.floor(1e3*e)/1e3,decMatch=result.match(/.*\.(.*)$/),null==decMatch?result+=".000":1==decMatch[1].length?result+="00":2==decMatch[1].length&&(result+="0"),result}function initPieChart(e,t){for(var n=[],a=[],o=0;o<e.length;o++){var s={};s.label=e[o],s.data=1,s.pct="0%",s.qos="0kb",a.push(s)}for(var o=0;o<t.length;o++){var l={};l.label=t[o],l.data=1,l.pct="0%",l.qos="0kb",n.push(l)}initPies(n,a),Ha.setFooterPosition()}function updatePieChart(e,t,n,a){for(var o=[],s=[],l=0;l<a.length;l++){var r=a[l].split("-");if("undefined"==typeof r[2])return;down={},down.label=r[0],down.qos=r[1],down.pct=r[2].replace("(","").replace(")",""),down.data=parseFloat(down.pct),o.push(down)}for(var l=0;l<t.length;l++){var r=t[l].split("-");up={},up.label=r[0],up.qos=r[1],up.pct=r[2].replace("(","").replace(")",""),up.data=parseFloat(up.pct),s.push(up)}updatePies(o,s),Ha.setFooterPosition()}function formateLabel(e){for(var t=0;t<e.length;t++)for(var n in UI)e[t]==n&&(e[t]=UI[n]);return e}window.onresize=function(){try{"block"==document.getElementById("darken").style.display&&setControlsEnabled(!1,"block"==document.getElementById("wait_msg").style.display)}catch(e){}};var qosStr=new Object,uploadClassIds=[],downloadClassIds=[],uploadClassNames=[],downloadClassNames=[],uploadUpdateInProgress=!1,downloadUpdateInProgress=!1,updateInProgress=!1,setUploadPie=null,setDownloadPie=null,ctx_up,ctx_down,data_up,data_down,upPieChart,downPieChart;$("#down-btns").find("button").click(function(){var e=$(this).attr("data-value");$("#down-btns").find("button").removeClass("active"),$(this).addClass("active"),$("#down_timeframe").val(e),updatePieCharts()}),$("#up-btns").find("button").click(function(){var e=$(this).attr("data-value");$("#up-btns").find("button").removeClass("active"),$(this).addClass("active"),$("#up_timeframe").val(e),updatePieCharts()}),initializePieCharts();