function checkIPs(){var e=0,t=$("#add_ip").val();return 0!=t.length&&Validate.vaIPS(t)?($("#add_ip_input").addClass("has-error"),$("#add_ip_help").html("<span>"+UI.There_is_invalid_IP_or_IP_range_Exists+".</span>"),$(".add_ip_btn").prop("disabled",!0),e=1):($("#add_ip_help").removeClass("hidden").html(UI.Specify_an_IP_or_IP_range),$("#add_ip_input").removeClass("has-error"),$(".add_ip_btn").prop("disabled",!1)),e}function checkQos(e){var t=0,a=e.val();return Validate.vaFloat(a)||Validate.vaLength(a)?(e.parent().addClass("has-error"),e.next(".help-block").removeClass("hidden"),t=1):(e.parent().removeClass("has-error"),e.next(".help-block").addClass("hidden")),t}function checkWeekly(){var e=0,t=$("#active_weekly").val();return validateWeeklyRange(t)?($("#active_weekly_container").addClass("has-error"),$("#active_weekly_container").find(".warn_help").removeClass("hidden"),e=1):($("#active_weekly_container").removeClass("has-error"),$("#active_weekly_container").find(".warn_help").addClass("hidden")),e}function checkHours(){var e=0,t=$("#active_hours").val();return validateHours(t)?($("#active_hours_container").addClass("has-error"),$("#active_hours_container").find(".warn_help").removeClass("hidden"),e=1):($("#active_hours_container").removeClass("has-error"),$("#active_hours_container").find(".warn_help").addClass("hidden")),e}function validateMaxAll(){var e=0,t=$("#max_up_type").val(),a=$("#max_down_type").val(),n=$("#max_combined_type").val();return"unlimited"==t&&"unlimited"==a&&"unlimited"==n?($("#max_up_form_group,#max_down_form_group,#max_combined_form_group").addClass("has-error"),$("#max_all_help").removeClass("hidden"),e=1):($("#max_up_form_group,#max_down_form_group,#max_combined_form_group").removeClass("has-error"),$("#max_all_help").addClass("hidden")),e}function checkMax(e){var t=0,a=e.val(),n=e.parent();return Validate.vaFloat(a)||Validate.vaLength(a)?0===parseInt(a)?(n.removeClass("has-error"),n.find(".help-block").addClass("hidden")):(n.addClass("has-error"),n.find(".help-block").removeClass("hidden"),t=1):(n.removeClass("has-error"),n.find(".help-block").addClass("hidden")),t}function disableSaveBtn(){var e=0;return"limited"==$("#max_up_type").val()&&(e+=checkMax($("#max_up"))),"limited"==$("#max_down_type").val()&&(e+=checkMax($("#max_down"))),"limited"==$("#max_combined_type").val()&&(e+=checkMax($("#max_combined"))),e+=validateMaxAll(),"only"==$("#applies_to_type").val()&&(e+=checkIPs()),$("#active_hours_container").hasClass("hidden")||(e+=checkHours()),$("#active_weekly_container").hasClass("hidden")||(e+=checkWeekly()),$("#quota_only_qos_container").hasClass("hidden")||(e+=checkQos($("#quota_qos_up")),e+=checkQos($("#quota_qos_down"))),e?$("#save_quota").prop("disabled",!0):$("#save_quota").prop("disabled",!1),e}function alterQuotaExceeded(){var e=$("#quota_exceeded").val();return"throttle"==e?($("#quota_full_qos_container").addClass("hidden"),$("#quota_full_qos_up_class,#quota_full_qos_down_class").prop("disabled",!0).val(""),$("#quota_only_qos_container").removeClass("hidden"),$("#quota_qos_up,#quota_qos_down").val("").prop("disabled",!1),$("#quota_qos_down_unit").prop("disabled",!1).find("option").first().prop("selected",!0),void $("#quota_qos_up_unit").prop("disabled",!1).find("option").first().prop("selected",!0)):"combined"==e?($("#quota_full_qos_container").removeClass("hidden"),$("#quota_full_qos_up_class").prop("disabled",!1).find("option").first().prop("selected",!0),$("#quota_full_qos_down_class").prop("disabled",!1).find("option").first().prop("selected",!0),$("#quota_only_qos_container").addClass("hidden"),$("#quota_qos_up,#quota_qos_down").val("").prop("disabled",!0),$("#quota_qos_down_unit").prop("disabled",!0).val(""),void $("#quota_qos_up_unit").prop("disabled",!0).val("")):($("#quota_full_qos_container").addClass("hidden"),$("#quota_full_qos_up_class,#quota_full_qos_down_class").prop("disabled",!0).val(""),$("#quota_only_qos_container").addClass("hidden"),$("#quota_qos_up,#quota_qos_down").val("").prop("disabled",!0),void $("#quota_qos_up_unit,#quota_qos_down_unit").prop("disabled",!0).val(""))}function alterQuoteaReset(){var e=$("#quota_reset").val();if("hour"==e)$("#quota_day").prop("disabled",!0).parent().parent().addClass("hidden"),$("#quota_hour").prop("disabled",!0).parent().parent().addClass("hidden");else if("day"==e)$("#quota_day").prop("disabled",!0).parent().parent().addClass("hidden"),$("#quota_hour").prop("disabled",!1).parent().parent().removeClass("hidden");else if("week"==e){$("#quota_day").prop("disabled",!1).parent().parent().removeClass("hidden"),$("#quota_hour").prop("disabled",!1).parent().parent().removeClass("hidden");var t,a=[UI.Sunday,UI.Monday,UI.Tuesday,UI.Wednesday,UI.Thursday,UI.Friday,UI.Saturday],n=[];for(t=0;t<7;t++)n.push(60*t*60*24+"");setAllowableSelections("quota_day",n,a,document)}else{$("#quota_day").prop("disabled",!1).parent().parent().removeClass("hidden"),$("#quota_hour").prop("disabled",!1).parent().parent().removeClass("hidden");var n=[],a=[],o=1;for(o=1;o<=28;o++){var s=""+o,i=s.substr(s.length-1,1),r=quotasStr.Digs;o%100!=11&&"1"==i&&(r=quotasStr.LD1s),o%100!=12&&"2"==i&&(r=quotasStr.LD2s),o%100!=13&&"3"==i&&(r=quotasStr.LD3s),a.push(s+r),n.push(60*(o-1)*60*24+"")}setAllowableSelections("quota_day",n,a,document)}}function alterQuotaActive(){var e=$("#quota_active").val();if("always"==e)$("#quota_active").parent().addClass("col-sm-12").removeClass("col-sm-6"),$("#quota_active_type").prop("disabled",!0).parent().addClass("hidden"),$("#active_hours").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_weekly").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_days_container").addClass("hidden");else{$("#quota_active").parent().removeClass("col-sm-12").addClass("col-sm-6"),$("#quota_active_type").prop("disabled",!1).parent().removeClass("hidden");var t=$("#quota_active_type").val();"hours"==t?($("#active_hours").prop("disabled",!1).parent().parent().removeClass("hidden"),$("#active_weekly").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_days_container").addClass("hidden")):"days"==t?($("#active_hours").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_weekly").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_days_container").removeClass("hidden")):"days_and_hours"==t?($("#active_hours").prop("disabled",!1).parent().parent().removeClass("hidden"),$("#active_weekly").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_days_container").removeClass("hidden")):($("#active_hours").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_weekly").prop("disabled",!1).parent().parent().removeClass("hidden"),$("#active_days_container").addClass("hidden"))}disableSaveBtn()}function alterQuotaActiveType(){var e=$("#quota_active_type").val();"hours"==e?($("#active_hours").prop("disabled",!1).parent().parent().removeClass("hidden"),$("#active_weekly").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_days_container").addClass("hidden")):"days"==e?($("#active_hours").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_weekly").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_days_container").removeClass("hidden")):"days_and_hours"==e?($("#active_hours").prop("disabled",!1).parent().parent().removeClass("hidden"),$("#active_weekly").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_days_container").removeClass("hidden")):($("#active_hours").prop("disabled",!0).parent().parent().addClass("hidden"),$("#active_weekly").prop("disabled",!1).parent().parent().removeClass("hidden"),$("#active_days_container").addClass("hidden")),disableSaveBtn()}function alterLimitInput(e,t,a){var n=$("#"+e).val();"limited"==n?($("#"+e).parent().removeClass("col-sm-12").addClass("col-sm-4"),$("#"+t).prop("disabled",!1).parent().removeClass("hidden"),$("#"+t).focus(),$("#"+a).prop("disabled",!1).parent().removeClass("hidden")):($("#"+e).parent().addClass("col-sm-12").removeClass("col-sm-4"),$("#"+t).prop("disabled",!0).parent().addClass("hidden"),$("#"+a).prop("disabled",!0).parent().addClass("hidden"))}function alterApplyto(){var e=$("#applies_to_type").val();"only"==e?($("#ip_span_container").parent().parent().removeClass("hidden"),$("#add_ip_input").removeClass("hidden")):($("#ip_span_container").parent().parent().addClass("hidden"),$("#add_ip_input").addClass("hidden")),disableSaveBtn()}function getTableData(e){var t=e.getAllSectionsOfType(pkg,"quota"),a=[];for(i=0;i<t.length;i++){var n=e.get(pkg,t[i],"ip").toUpperCase(),o=e.get(pkg,t[i],"id");""==o&&(o=getIdFromIp(n),e.set(pkg,t[i],"id",o));var s=getTimeParametersFromUci(e,t[i],1),r=getLimitStrFromUci(e,t[i]),d=e.get(pkg,t[i],"enabled");d="0"!=d;var l=createEnabledCheckbox(d);a.push([ipToTableSpan(n),timeParamsToTableSpan(s),r,l,createBtn(UI.Edit,"primary"),createBtn(UI.Remove,"danger"),o])}return a}function getFormData(e){}function saveChanges(){Ha.mask.show();for(var e=[],t=uciOriginal.getAllSectionsOfType(pkg,"quota");t.length>0;){var a=t.shift();e.push("uci del "+pkg+"."+a)}e.push("uci commit");for(var n=uci.getAllSectionsOfType(pkg,"quota"),o="\nuci del gargoyle.status.quotause ; uci commit ;\n",s=[];n.length>0;){var a=n.shift(),i=uci.get(pkg,a,"id");s[i]=a,1==changedIds[i]&&uci.set(pkg,a,"ignore_backup_at_next_restore","1")}var r=[],d=[];$("#quota_container").find("tr").each(function(){r.push($(this).prop("id")),d.push($(this).find("input").prop("checked"))});var l=0;for(l=0;l<r.length;l++){var u=s[r[l]];null!=u&&(uci.set(pkg,u,"enabled",d[l]?"1":"0"),d[l]&&(o='\nuci set gargoyle.status.quotause="225" ; uci commit ;\n'))}var p=[];p.push("sh /usr/lib/gargoyle/restart_firewall.sh"),p.push('if [ -d "/usr/data/quotas/" ] ; then rm -rf /usr/data/quotas/* ; fi ;'),p.push("backup_quotas");for(var c=(e.join("\n")+"\n"+uci.getScriptCommands(uciOriginal)+"\n"+o+"\n"+p.join("\n"),[]),_=0;_<r.length;_++){var m="",h=uci.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<h.length&&""==m;sectionIndex++)uci.get(pkg,h[sectionIndex],"id")==r[_]&&(m=h[sectionIndex]);var g={};g.id=r[_],g.quota_section=m,g.enabled=d[_]?1:0,g.ip=uci.get(pkg,m,"ip"),g.reset_interval=uci.get(pkg,m,"reset_interval"),g.egress_limit=uci.get(pkg,m,"egress_limit"),g.ingress_limit=uci.get(pkg,m,"ingress_limit"),g.combined_limit=uci.get(pkg,m,"combined_limit"),g.reset_time=uci.get(pkg,m,"reset_time"),g.exceeded_up_speed=uci.get(pkg,m,"exceeded_up_speed"),g.exceeded_down_speed=uci.get(pkg,m,"exceeded_down_speed"),(parseInt(g.exceeded_up_speed)<1||parseInt(g.exceeded_down_speed)<1||isNaN(g.exceeded_up_speed)||isNaN(g.exceeded_down_speed))&&(g.exceeded_up_speed="",g.exceeded_down_speed=""),g.exceeded_up_class_mark=uci.get(pkg,m,"exceeded_up_class_mark"),g.exceeded_down_class_mark=uci.get(pkg,m,"exceeded_down_class_mark"),g.offpeak_hours=uci.get(pkg,m,"offpeak_hours"),g.offpeak_weekdays=uci.get(pkg,m,"offpeak_weekdays"),g.offpeak_weekly_ranges=uci.get(pkg,m,"offpeak_weekly_ranges"),g.onpeak_hours=uci.get(pkg,m,"onpeak_hours"),g.onpeak_weekdays=uci.get(pkg,m,"onpeak_weekdays"),g.onpeak_weekly_ranges=uci.get(pkg,m,"onpeak_weekly_ranges");var v=g.id.split("_")[0],I=g.ip.split(",")[0];v!=I&&(g.id=getIdFromIp(g.ip)),c.push(g)}var g={app:"quotas",action:"quotas_save_change",quots:c};$.post("/",g,function(e){Ha.mask.hide(),Ha.showNotify(e),setTimeout(function(){window.location.href=window.location.href},5e3)},"json")}function resetData(){allQuotaIds=quotaIdList,allQuotaIps=quotaIpLists,allQuotaUsed=quotaUsed,allQuotaLimits=quotaLimits,allQuotaPercents=quotaPercents,idToSection=[],idToIpStr=[],idToTimeParams=[];var e,t=uciOriginal.getAllSectionsOfType(pkg,"quota");for(e=0;e<t.length;e++){var a=getIpFromUci(uciOriginal,t[e]),n=uciOriginal.get(pkg,t[e],"id");n=""==n?getIdFromIp_usage(a,uciOriginal):n,idToSection[n]=t[e],idToIpStr[n]=a,idToTimeParams[n]=getTimeParametersFromUci(uciOriginal,t[e])}refreshTableData($("#data_display").val()),setInterval(updateTableData,1500);var o=0;for(upQosClasses=[],upQosMarks=[],downQosClasses=[],downQosMarks=[],o=0;o<qosMarkList.length;o++){var s=qosMarkList[o][1],i=uciOriginal.get("qos_shellgui",s,"name");s=""==i?s:i,"upload"==qosMarkList[o][0]?(upQosClasses.push(s),upQosMarks.push(qosMarkList[o][2])):(downQosClasses.push(s),downQosMarks.push(qosMarkList[o][2]))}var t=uciOriginal.getAllSectionsOfType(pkg,"quota"),r=[],d=[],l=[];for(changedIds=[],sectionIndex=0;sectionIndex<t.length;sectionIndex++){var a=uciOriginal.get(pkg,t[sectionIndex],"ip").toUpperCase(),n=uciOriginal.get(pkg,t[sectionIndex],"id");""==n&&(n=getIdFromIp(a),uci.set(pkg,t[sectionIndex],"id",n));var u=getTimeParametersFromUci(uci,t[sectionIndex],1),p=getLimitStrFromUci(uci,t[sectionIndex]),c=uciOriginal.get(pkg,t[sectionIndex],"enabled");c="0"!=c;var _=createEnabledCheckbox(c);d.push(_),l.push(c),r.push([ipToTableSpan(a),timeParamsToTableSpan(u),p,_,createBtn(UI.Edit,"primary"),createBtn(UI.Remove,"danger"),n])}for(resetTable(r);d.length>0;){var m=d.shift(),h=l.shift();m.checked=h}uci=uciOriginal.clone(),setDocumentFromUci(document,new UCIContainer,"")}function ipToTableSpan(e){var t=e;return"ALL_OTHERS_INDIVIDUAL"==t?t=quotasStr.OthersOne:"ALL_OTHERS_COMBINED"==t?t=quotasStr.OthersAll:"ALL"!=t&&""!=t||(t=quotasStr.All),textListToSpanElement(t.split(/[\t ]*,[\t ]*/),!0,document)}function createTrs(e){for(var t=[],a=0;a<e.length;a++){for(var n="",o=0;o<e[a].length-1;o++)n+="<td>"+e[a][o]+"</td>";t.push(n)}for(var s="",i=0;i<t.length;i++)s+='<tr class="text-left" id="'+e[i][6]+'">'+t[i]+"</tr>";return s}function createUsageTrs(e){for(var t=[],a=0;a<e.length;a++){for(var n="",o=0;o<e[a].length;o++)n+="<td>"+e[a][o]+"</td>";t.push(n)}for(var s="",i=0;i<t.length;i++)s+='<tr class="text-left">'+t[i]+"</tr>";return s}function createTr(e,t,a,n){var o='<tr class="text-left" id="'+e+'"><td>'+ipToTableSpan(t)+"</td><td>"+timeParamsToTableSpan(a)+"</td><td>"+n+"</td><td>"+createEnabledCheckbox(!0)+"</td><td>"+createBtn(UI.Edit,"primary")+"</td><td>"+createBtn(UI.Remove,"danger")+"</td></tr>";return o}function timeParamsToTableSpan(e){var t=e[0],a=e[1],n=e[2],o=e[3],s=[];return"always"==o?s.unshift(UI.Always):(""!=n?s=n.match(",")?n.split(/[\t ]*,[\t ]*/):[n]:(""!=t&&(s=t.match(",")?t.split(/[\t ]*,[\t ]*/):[t]),""!=a&&s.unshift(a)),s.unshift("only"==o?quotasStr.Only+":":quotasStr.AllExcept+":")),textListToSpanElement(s,!1,document)}function getLimitStrFromUci(e,t){var a=uci.get(pkg,t,"combined_limit"),n=uci.get(pkg,t,"ingress_limit"),o=uci.get(pkg,t,"egress_limit"),s=function(e){return""==e?quotasStr.NA:parseBytes(Validate.parsePaddedInt(e),null,!0).replace(/\.[\d]+/,"").replace(/[\t ]+/,"")};return s(a)+"/"+s(n)+"/"+s(o)}function getIdFromIp(e){id=""==e?"ALL":e.replace(/[\t, ]+.*$/,""),id=id.replace(/\//,"_");for(var t=id,a=!0,n=0,o=uci.getAllSectionsOfType(pkg,"quota");a;){a=!1;var s;for(s=0;s<o.length&&!a;s++)a=a||uci.get(pkg,o[s],"id")==id;if(a){var i="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r=n<26?"_"+i.substr(n,1):"_Z"+(n-25);id=t+r}n++}return id}function getIpFromDocument(e){e=null==e?document:e;var t="ALL";if("all"==getSelectedValue("applies_to_type",e))t="ALL";else if("others_combined"==getSelectedValue("applies_to_type",e))t="ALL_OTHERS_COMBINED";else if("others_individual"==getSelectedValue("applies_to_type",e))t="ALL_OTHERS_INDIVIDUAL";else if("only"==getSelectedValue("applies_to_type",e)){var a=[];$("#ip_span_container").find(".ip_span").each(function(){a.push($(this).html())}),a.length>0&&(t=a.join(","))}return t}function setDocumentIp(e,t){if(e=""==e?"ALL":e,t=null==t?document:t,$("#add_ip").val(""),$("#ip_span_container").html(""),"ALL"==e)setSelectedValue("applies_to_type","all",t);else if("ALL_OTHERS_COMBINED"==e)setSelectedValue("applies_to_type","others_combined",t);else if("ALL_OTHERS_INDIVIDUAL"==e)setSelectedValue("applies_to_type","others_individual",t);else{$("#applies_to_type").val("only"),$("#ip_span_container").parent().parent().removeClass("hidden"),$("#add_ip_input").removeClass("hidden"),$("#add_ip").val(e);var a=addAddressesToTable(t,"add_ip","ip_span_container","quota_ip_table",!1,3,!1,!1);a||$("#add_ip").val("")}}function addNewQuota(){var e=validateQuota(document,"","none");if(e.length>0)Ha.showNotify({status:1,msg:e[0]+"<br>"+quotasStr.AddError});else{for(var t=1;""!=uci.get(pkg,"quota_"+t,"");)t++;setUciFromDocument(document,"");var a=(uci.get(pkg,"quota_"+t,"id"),getIpFromDocument(document),getTimeParametersFromUci(uci,"quota_"+t),getLimitStrFromUci(pkg,"quota_"+t),getTableData(uci));resetTable(a),$("#quotaModal").modal("hide"),setDocumentFromUci(document,new UCIContainer,"")}}function setVisibility(e){e=null==e?document:e,fullQosEnabled?($("#quota_only_qos_container").addClass("hidden"),$("#quota_only_qos_container").find("select").prop("disabled",!0),$("#quota_only_qos_container").find("input").prop("disabled",!0)):($("#quota_full_qos_container").addClass("hidden"),$("#quota_full_qos_container").find("select").prop("disabled",!0),$("#quota_full_qos_container").find("input").prop("disabled",!0))}function getDaySeconds(e){return 86400*Math.floor(e/86400)}function getHourSeconds(e){return 3600*Math.floor(e%86400/3600)}function timeVariablesToWeeklyRanges(e,t,a,n){var e=null==e?"":e,t=null==t?"":t,a=null==a?"":a,o=[];o[UI.Sun.toUpperCase()]=0,o[UI.Mon.toUpperCase()]=1,o[UI.Tue.toUpperCase()]=2,o[UI.Wed.toUpperCase()]=3,o[UI.Thu.toUpperCase()]=4,o[UI.Fri.toUpperCase()]=5,o[UI.Sat.toUpperCase()]=6;var s=function(e,t){var a,n=[];for(a=0;a<e.length;a+=2){if(e[a+1]<e[a]){var o=e[a+1];e[a+1]=t,e.push(0),e.push(o)}var s=e[a],i=e[a+1];n.push([s,i])}var r=function(e,t){return e[0]-t[0]},d=n.sort(r),l=[];for(a=0;a<d.length;a++)l.push(d[a][0]),l.push(d[a][1]);return l},i=[];if(""==e&&""==t&&""==a)i=[0,604800],n=!1;else if(""!=a){var r,d=function(e){var t=e.split(/[:\t ]+/),a=t[0].substr(0,3).toUpperCase();return t[0]=null!=o[a]?24*o[a]*60*60:0,t[1]=Validate.parsePaddedInt(t[1])+""!="NaN"?60*Validate.parsePaddedInt(t[1])*60:0,t[2]=Validate.parsePaddedInt(t[2])+""!="NaN"?60*Validate.parsePaddedInt(t[2]):0,t[3]=null!=t[3]&&Validate.parsePaddedInt(t[3])+""!="NaN"?Validate.parsePaddedInt(t[3]):0,t[0]+t[1]+t[2]+t[3]},l=a.split(/[\t ]*,[\t ]*/);for(r=0;r<l.length;r++){var u=l[r].split(/[\t ]*\-[\t ]*/);i.push(d(u[0])),i.push(d(u[1]))}i=s(i,604800)}else{var p=[1,1,1,1,1,1,1],c=[];if(""!=t){p=[0,0,0,0,0,0,0];var _,m=t.split(/[\t ]*,[\t ]*/);for(_=0;_<m.length;_++){var h=m[_].substr(0,3).toUpperCase();null!=o[h]&&(p[o[h]]=1)}}if(""!=e){var r,d=function(e){var t=e.split(/[:\t ]+/);return t[0]=Validate.parsePaddedInt(t[0])+""!="NaN"?60*Validate.parsePaddedInt(t[0])*60:0,t[1]=Validate.parsePaddedInt(t[1])+""!="NaN"?60*Validate.parsePaddedInt(t[1]):0,t[2]=null!=t[2]&&Validate.parsePaddedInt(t[2])+""!="NaN"?Validate.parsePaddedInt(t[2]):0,t[0]+t[1]+t[2]},l=e.split(/[\t ]*,[\t ]*/);for(r=0;r<l.length;r++){var g=l[r].replace(/^[\t ]*/,"").replace(/[\t ]*$/,""),u=g.split(/[\t ]*\-[\t ]*/);c.push(d(u[0])),c.push(d(u[1]))}c=s(c,86400)}c=0==c.length?[0,86400]:c;var _;for(_=0;_<p.length;_++)if(0!=p[_]){var v;for(v=0;v<c.length;v++)i.push(24*_*60*60+c[v])}}return n&&(0==i[0]?i.shift():i.unshift(0),604800==i[i.length-1]?i.pop():i.push(604800)),i}function rangesOverlap(e,t){var a=timeVariablesToWeeklyRanges(e[0],e[1],e[2],e[3]),n=timeVariablesToWeeklyRanges(t[0],t[1],t[2],t[3]),o=0,s=0,i=!1;for(o=0;o<a.length&&!i;o+=2){var r=a[o],d=a[o+1],l=n[s],u=n[s+1];for(i=i||d>l&&r<u;!i&&l<r&&s<n.length;)if(s+=2,s<n.length){var l=n[s],u=n[s+1];i=i||d>l&&r<u}}return i}function validateQuota(e,t,a){t=null==t?"":t,a=null==a?"none":a,e=null==e?document:e;var n=["max_up","max_down","max_combined","active_hours","active_weekly"],o=["max_up_label","max_down_label","max_combined_label","quota_active_label","quota_active_label"],s=[validateDecimal,validateDecimal,validateDecimal,validateHours,validateWeeklyRange],i=[0,0,0,0,0],r=["max_up_container","max_down_container","max_combined_container","active_hours_container","active_weekly_container"],d=proofreadFields(n,o,s,i,r,e);if(0==d.length&&"only"==$("#applies_to_type").val()&&""!=$("#add_ip").val()){var l=addAddressesToTable(e,"add_ip","ip_span_container","quota_ip_table",!1,3,!1,!1);l||d.push(UI.There_is_invalid_IP_or_IP_range_Exists+".")}var u="";if(0==d.length&&(u=getIpFromDocument(e),""==u&&d.push(quotasStr.IPError)),0==d.length&&"unlimited"==getSelectedValue("max_up_type",e)&&"unlimited"==getSelectedValue("max_down_type",e)&&"unlimited"==getSelectedValue("max_combined_type",e)&&d.push(quotasStr.AllUnlimitedError),0==d.length&&u!=a){var p,c=uci.getAllSectionsOfType(pkg,"quota"),_=!1;for(p=0;p<c.length&&!_;p++){var m=uci.get(pkg,c[p],"id");if(m!=t){var h=uci.get(pkg,c[p],"ip"),g=testAddrOverlap(h,u);if(g){var v=getTimeParametersFromDocument(e),I=getTimeParametersFromUci(uci,c[p]);v[3]="except"==v[3],I[3]="except"==I[3],_=rangesOverlap(v,I)}}}_&&(u.match(/ALL/)?u.match(/OTHER/)?d.push(quotasStr.OneTimeQuotaError):d.push(quotasStr.OneNetworkQuotaError):d.push(quotasStr.DuplicateRange))}return $("#quota_only_qos_container").hasClass("hidden")||(parseInt($("#quota_qos_down").val())<1||isNaN(parseInt($("#quota_qos_down").val()))||parseInt($("#quota_qos_up").val())<1||isNaN(parseInt($("#quota_qos_up").val())))&&d.push("上传和下载的限制输入不合法！"),d}function addAddressesToTable(e,t,a,n,o,s,i,r){var d=$("#"+t).val(),l=addAddressStringToTable(e,d,a,n,o,s,i,r);return l&&$("#"+t).val(""),l}function addAddressStringToTable(e,t,a,n,o,s,i,r){o=null==o||o,s=null==s?3:s;var d;d=0==s?function(){return 1}:1==s?Validate.vaIP:2==s?Validate.vaIpRange:Validate.vaIPS;var l=[],u=[];if(null!=$("#"+a).html()){var p=[];$("#"+a).find(".ip_span").each(function(){p.push($(this).html())});var c;for(c=0;c<p.length;c++){var _=p[c];0==Validate.vaMac(_)?l.push(_):u.push(_)}}e=null==e?document:e;var m=0,h=t.split(/[\t ]*,[\t ]*/);m=h.length>0?0:1;var g;for(g=0;g<h.length&&0==m;g++){var _=h[g],v=o&&0==Validate.vaMac(_),I=0==d(_);if(v||I){var f=v?l:u;m=0!=f.length&&testAddrOverlap(_,f.join(","))?1:0,0==m&&f.push(_)}else m=1}if(0==m){t=t.replace(/^[\t ]*/,""),t=t.replace(/[\t ]*$/,"");var y=t.split(/[\t ]*,[\t ]*/);makeIpTable(y,a)}else i&&alert(UI.InvAdd+"\n");return 0==m}function parseKbytesPerSecond(e,t){var a;return t="bytes/s"!=t&&"KBytes/s"!=t&&"MBytes/s"!=t?"mixed":t,a="mixed"==t&&e>1024||"MBytes/s"==t?(e/1024).toFixed(3)+" "+UI.MBs:e+" "+UI.KBs}function makeIpTable(e,t){for(var a=0;a<e.length;a++){var n='<span class="ip_spans"><span class="ip_span">'+e[a]+'</span>&nbsp;<span class="del_ip_span" title="delete this ip(s)">&times;</span>&nbsp;&nbsp;&nbsp;&nbsp;</span><wbr>';$("#"+t).append(n),$(".del_ip_span").click(function(){$(this).parent().remove()})}}function setDocumentFromUci(e,t,a){e=null==e?document:e;var n="",o=t.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<o.length&&""==n;sectionIndex++)t.get(pkg,o[sectionIndex],"id")==a&&(n=o[sectionIndex]);$("#save_quota").attr("data-id",a);var s=t.get(pkg,n,"ip");s=""==s?"ALL":s;var i=t.get(pkg,n,"reset_interval"),r=t.get(pkg,n,"egress_limit"),d=t.get(pkg,n,"ingress_limit"),l=t.get(pkg,n,"combined_limit");i=""==i||"minute"==i?"day":i;var u=t.get(pkg,n,"reset_time");u=""==u?0:parseInt(u);var p=getDaySeconds(u),c=getHourSeconds(u),_=t.get(pkg,n,"exceeded_up_speed"),m=t.get(pkg,n,"exceeded_down_speed"),h=t.get(pkg,n,"exceeded_up_class_mark"),g=t.get(pkg,n,"exceeded_down_class_mark");setDocumentIp(s,e),setSelectedValue("quota_reset",i,e),alterQuoteaReset();var v=getTimeParametersFromUci(t,n),I=v[1],f=["sun","mon","tue","wed","thu","fri","sat"],y=[];y=""==I?f:I.split(/,/);var q=0;for(q=0;q<f.length;q++){var k=f[q],b=!1,x=0;for(x=0;x<y.length&&!b;x++)b=y[x]==k;$("#quota_"+f[q]).prop("checked",b)}$("#active_hours").val(v[0]),$("#active_weekly").val(v[2]);var U=v[3];if($("#quota_active").val(U),"always"!=U){var S=[];S["000"]="hours",S[100]="hours",S["010"]="days",S[110]="days_and_hours";var w=(""!=v[0]?"1":"0")+(""!=v[1]?"1":"0")+(""==v[2]?"0":"1"),C=null!=S[w]?S[w]:"weekly_range";$("#quota_active_type").val(C)}alterQuotaActiveType(),alterQuotaActive(),alterApplyto(),$("#max_up_type").val(""==r?"unlimited":"limited"),$("#max_down_type").val(""==d?"unlimited":"limited"),$("#max_combined_type").val(""==l?"unlimited":"limited"),alterLimitInput("max_up_type","max_up","max_up_unit"),alterLimitInput("max_down_type","max_down","max_down_unit"),alterLimitInput("max_combined_type","max_combined","max_combined_unit"),setDocumentLimit(r,"max_up","max_up_unit",e),setDocumentLimit(d,"max_down","max_down_unit",e),setDocumentLimit(l,"max_combined","max_combined_unit",e);var T;""!=_&&""!=m?T="throttle":""!=h||""!=g?fullQosEnabled&&(T="combined"):""==_&&""==m&&""==h&&""==g&&(T="hard_cutoff"),$("#quota_exceeded").val(T),alterQuotaExceeded(),setDocumentSpeed(_,"quota_qos_up","quota_qos_up_unit",e),setDocumentSpeed(m,"quota_qos_down","quota_qos_down_unit",e),$("#quota_day").val(p+""),$("#quota_hour").val(c+""),fullQosEnabled&&(setAllowableSelections("quota_full_qos_up_class",upQosMarks,upQosClasses,e),setAllowableSelections("quota_full_qos_down_class",downQosMarks,downQosClasses,e),""!=h&&""!=g&&($("#quota_full_qos_up_class").val(h),$("#quota_full_qos_down_class").val(g)))}function setDocumentLimit(e,t,a,n){e=""==e?0:parseInt(e);var o=n.getElementById(t),s=UI.MB,i=1048576;if(e<=0)setSelectedValue(a,s,n),o.value="0";else{var r=parseBytes(e),d=s,l=i;r.match(new RegExp(UI.GBy))&&(d=UI.GB,l=1073741824),r.match(new RegExp(UI.TBy))&&(d=UI.TB,l=1099511627776),setSelectedValue(a,d,n);var u=truncateDecimal(e/l);o.value=u}}function setDocumentSpeed(e,t,a,n){var o=UI.KBs,s=n.getElementById(t);if(setSelectedValue(a,o,n),e=""==e?0:parseInt(e),e<=0)s.value="0";else{var i=parseKbytesPerSecond(e),r=i.split(/[\t ]+/);switch(s.value=r[0],r[1]){case UI.KBs:o="KBytes/s";break;case UI.MBs:o="MBytes/s"}setSelectedValue(a,o,n)}}function testAddrOverlap(e,t){e=e.replace(/^[\t ]+/,""),e=e.replace(/[\t ]+$/,""),t=t.replace(/^[\t ]+/,""),t=t.replace(/[\t ]+$/,"");var a,n=e.split(/[,\t ]+/),o=t.split(/[,\t ]+/),s=!1;for(a=0;a<n.length&&!s;a++){var i;for(i=0;i<o.length&&!s;i++)s=s||testSingleAddrOverlap(n[a],o[i])}return s}function testSingleAddrOverlap(e,t){var a=function(e){return e=""==e?"ALL":e.toUpperCase(),"ALL_OTHERS_COMBINED"!=e&&"ALL_OTHERS_INDIVIDUAL"!=e||(e="ALL_OTHERS_COMBINED"),e};e=a(e),t=a(t);var n=!1;if(e==t)n=!0;else if(Validate.vaIPS(e)>0||Validate.vaIPS(t)>0||e.match(",")||t.match(","))n=!1;else{var o=getIpRangeIntegers(e),s=getIpRangeIntegers(t);n=o[0]<=s[1]&&o[1]>=s[0]}return n}function getIpRangeIntegers(e){var t=0,a=0;if(e.match(/\//)){var n=e.split(/[\t ]*\/[\t ]*/),o=Validate.getIpInteger(n[0]),s=n[1].match(/\./)?Validate.getIpInteger(n[1]):getMaskInteger(n[1]);t=o&s,a=t|~s}else if(e.match(/-/)){var n=e.split(/[\t ]*\-[\t ]*/);t=Validate.getIpInteger(n[0]),a=Validate.getIpInteger(n[1])}else t=Validate.getIpInteger(e),a=t;return[t,a]}function setUciFromDocument(e,t){e=null==e?document:e;var a=getIpFromDocument(e);t=null==t?"":t,t=""==t?getIdFromIp(a):t;var n="",o=uci.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<o.length;sectionIndex++)uci.get(pkg,o[sectionIndex],"id")==t&&(n=o[sectionIndex]);if(""==n){for(var s=1;""!=uci.get(pkg,"quota_"+s,"");)s++;n="quota_"+s,uci.set(pkg,n,"","quota")}var i=uci.get(pkg,n,"ip");i!=a&&(testAddrOverlap(i,a)||(changedIds[t]=1)),uci.set(pkg,n,"ingress_limit",getDocumentLimit("max_down","max_down_type","max_down_unit",e)),uci.set(pkg,n,"egress_limit",getDocumentLimit("max_up","max_up_type","max_up_unit",e)),uci.set(pkg,n,"combined_limit",getDocumentLimit("max_combined","max_combined_type","max_combined_unit",e)),uci.set(pkg,n,"exceeded_up_speed",getDocumentSpeed("quota_only_qos_container","quota_qos_up","quota_qos_up_unit",e)),uci.set(pkg,n,"exceeded_down_speed",getDocumentSpeed("quota_only_qos_container","quota_qos_down","quota_qos_down_unit",e));var r,d,l=getDocumentSpeed("quota_only_qos_container","quota_qos_up","quota_qos_up_unit",e),u=getDocumentSpeed("quota_only_qos_container","quota_qos_down","quota_qos_down_unit",e);r=l?"":getDocumentMark("quota_full_qos_container","quota_full_qos_up_class",e),d=u?"":getDocumentMark("quota_full_qos_container","quota_full_qos_down_class",e),uci.set(pkg,n,"exceeded_up_class_mark",getDocumentMark("quota_full_qos_container","quota_full_qos_up_class",e)),uci.set(pkg,n,"exceeded_down_class_mark",getDocumentMark("quota_full_qos_container","quota_full_qos_down_class",e)),uci.set(pkg,n,"reset_interval",getSelectedValue("quota_reset",e)),uci.set(pkg,n,"ip",a),uci.set(pkg,n,"id",t);var p=getSelectedValue("quota_day",e),c=getSelectedValue("quota_hour",e);p=""==p?"0":p,c=""==c?"0":c;var _=parseInt(p)+parseInt(c);if(_>0){var m=_+"";uci.set(pkg,n,"reset_time",m)}else uci.remove(pkg,n,"reset_time");var h=getTimeParametersFromDocument(e),g=h[3],v=["offpeak","onpeak"],I=0;for(I=0;I<v.length;I++){var f=v[I],y=function(e,t,a){e?uci.set(pkg,n,t,a):uci.remove(pkg,n,t)},q="offpeak"==f&&"except"==g||"onpeak"==f&&"only"==g;y(q,f+"_hours",h[0]),y(q,f+"_weekdays",h[1]),y(q,f+"_weekly_ranges",h[2])}}function getTimeParametersFromDocument(e){var t=$("#active_hours").parent().parent().hasClass("hidden")?"":$("#active_hours").val(),a=$("#active_weekly").parent().parent().hasClass("hidden")?"":$("#active_weekly").val(),n=[];if(!$("#active_days_container").hasClass("hidden")){var o,s=["sun","mon","tue","wed","thu","fri","sat"];for(o=0;o<s.length;o++)$("#quota_"+s[o]).prop("checked")&&n.push(s[o])}var i=""+n.join(","),r=$("#quota_active").val();return[t,i,weekly_i18n(a,"page"),r]}function getTimeParametersFromUci(e,t,a){var n=e.get(pkg,t,"offpeak_hours"),o=e.get(pkg,t,"offpeak_weekdays"),s=e.get(pkg,t,"offpeak_weekly_ranges"),i=""!=n||""!=o||""!=s?"except":"always";return"always"==i&&(n=e.get(pkg,t,"onpeak_hours"),o=e.get(pkg,t,"onpeak_weekdays"),s=e.get(pkg,t,"onpeak_weekly_ranges"),i=""!=n||""!=o||""!=s?"only":"always"),[n,1==a?dayToi18n(o):o,weekly_i18n(s,"uci"),i]}function getDocumentLimit(e,t,a,n){var o="";if("unlimited"!=getSelectedValue(t,n)){var s=getSelectedValue(a,n),i=1048576;"MB"==s&&(i=1048576),"GB"==s&&(i=1073741824),"TB"==s&&(i=1099511627776);var r=Math.round(i*parseFloat(n.getElementById(e).value));o=""+r}return o}function getDocumentSpeed(e,t,a,n){var o="";if(!$("#"+e).hasClass("hidden")){var s=getSelectedValue(a,n);"MBytes/s"==s&&(multiple=1024),"KBytes/s"==s&&(multiple=1);var i=Math.round(multiple*parseFloat(n.getElementById(t).value));o=""+i}return o}function getDocumentMark(e,t,a){var n="";return $("#"+e).hasClass("hidden")||(n=getSelectedValue(t,a)),n}function createEnabledCheckbox(e){var t=e?"checked":"",a='<input type="checkbox" '+t+">";return a}function createBtn(e,t){var t=t?t:"default",e=e?e:"",a='<button class="btn btn-xs btn-'+t+'">'+e+"</button>";return a}function setRowEnabled(){enabled=this.checked?"1":"0",enabledRow=this.parentNode.parentNode,enabledRow.childNodes[rowCheckIndex+1].firstChild.disabled=!this.checked,enabledRow.childNodes[rowCheckIndex+1].firstChild.className=this.checked?"default_button":"default_button_disabled";var e=this.id,t=e.split(/\./);""!=uci.get(pkg,t[0])&&uci.set(pkg,t[0],"enabled",enabled),""!=uci.get(pkg,t[1])&&uci.set(pkg,t[1],"enabled",enabled)}function removeQuotaCallback(e){var t=uci.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<t.length;sectionIndex++)uci.get(pkg,t[sectionIndex],"id")==e&&uci.removeSection(pkg,t[sectionIndex]);changedIds[e]=1}function resetTable(e){var t=createTrs(e);$("#quota_container").empty().append(t),$("#quota_container").find(".btn-primary").attr("data-toggle","modal").attr("data-target","#quotaModal").click(function(){var e=$(this).parent().parent().prop("id");$("#save_quota").html(UI.Save).attr("data-type","edit"),setDocumentFromUci(document,uci,e),disableSaveBtn()}),$("#quota_container").find(".btn-danger").click(function(){var e=$(this).parent().parent().prop("id");$(this).parent().parent().remove(),removeQuotaCallback(e)}),Ha.setFooterPosition()}function saveEdited(e){
var t,a=e,n="",o=uci.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<o.length&&""==n;sectionIndex++)uci.get(pkg,o[sectionIndex],"id")==a&&(n=o[sectionIndex],t=uci.get(pkg,n,"ip"));var s=validateQuota(document,a,t);if(s.length>0)Ha.showNotify({status:1,msg:s[0]+"<br>"+quotasStr.QuotaAddError});else{getIpFromDocument(document);setUciFromDocument(document,a);var i=getTableData(uci);$("#quotaModal").modal("hide"),resetTable(i)}}function dayToi18n(e){for(var t=e.split(","),a=0;a<t.length;a++)"sun"==t[a]&&(t[a]=UI.Sun),"mon"==t[a]&&(t[a]=UI.Mon),"tue"==t[a]&&(t[a]=UI.Tue),"wed"==t[a]&&(t[a]=UI.Wed),"thu"==t[a]&&(t[a]=UI.Thu),"fri"==t[a]&&(t[a]=UI.Fri),"sat"==t[a]&&(t[a]=UI.Sat);return t.join()}function weekly_i18n(e,t){if(e.length<6)return e;var a,n,o,s,i=[UI.Sun,UI.Mon,UI.Tue,UI.Wed,UI.Thu,UI.Fri,UI.Sat],r=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],d=[];for("uci"==t?(a=r,n=i):(a=i,n=r),o=e.split(" "),s=0;s<o.length;s++){var l=a.indexOf(o[s]);l>=0?d[s]=n[l]:d[s]=o[s]}return d.join(" ")}function validateDecimal(e){var t=null!=e.match(/^[\d]*\.?[\d]+$/)||null!=e.match(/^[\d]+\.?[\d]*$/)?0:1;return t}function validateHours(e){var t=e.match(/,/)?e.split(/,/):[e],a=!0;for(commaIndex=0;commaIndex<t.length&&a;commaIndex++){var n=t[commaIndex].split(/-/),o=2==n.length;o&&(o=o&&n[0].match(/^[\t ]*([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?[\t ]*$/),o=o&&n[1].match(/^[\t ]*([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?[\t ]*$/)),a=a&&o}return a?0:1}function validateWeeklyRange(e){var t=e.match(/,/)?e.split(/,/):[e],a=!0;for(commaIndex=0;commaIndex<t.length&&a;commaIndex++){var n=t[commaIndex].split(/-/),o=2==n.length;if(o){var s=new RegExp("^[\\t ]*("+UI.Sun+"|"+UI.Mon+"|"+UI.Tue+"|"+UI.Wed+"|"+UI.Thu+"|"+UI.Fri+"|"+UI.Sat+")[\\t ]*([0-1]?[0-9]|2[0-3])(:[0-5]?[0-9])?(:[0-5]?[0-9])?[\\t ]*$");o=o&&n[0].match(s),o=o&&n[1].match(s)}a=a&&o}return a?0:1}function proofreadFields(e,t,a,n,o,s){s=null==s?document:s;var i=new Array;for(idIndex in e)isVisible=!0,null!=o&&null!=o[idIndex]&&(isVisible=1!=$("#"+o[idIndex]).hasClass("hidden")),isVisible&&(inputId=e[idIndex],f=a[idIndex],proofreadText(inputId,f,n[idIndex]),f($("#"+inputId).val())!=n[idIndex]&&(labelStr=t[idIndex]+"",null!=$("#"+t[idIndex])?labelStr=$("#"+t[idIndex]).html():alert("error in proofread: label with id "+t[idIndex]+" is not defined"),i.push(UI.prfErr+" "+labelStr)));return i}function proofreadText(e,t,a){1!=$("#"+e).prop("disabled")&&$("#"+e).css("color",t($("#"+e).val())==a?"black":"red")}function setSelectedValue(e,t,a){var a=null==a?document:a,n=a.getElementById(e);null==n&&console.error(UI.Err+": "+e+" "+UI.nex);var o=!1;for(optionIndex=0;optionIndex<n.options.length&&!o;optionIndex++)o=n.options[optionIndex].value==t,o&&(n.selectedIndex=optionIndex);!o&&n.options.length>0&&n.selectedIndex<0&&(n.selectedIndex=0)}function setInvisibleIfIdMatches(e,t,a,n,o){o=null==o?document:o,n=null==n?"block":n;var s=o.getElementById(a),i=!1,r=0;if(null!=s){for(r=0;r<t.length;r++)i=getSelectedValue(e,o)==t[r]||i;i?s.style.display="none":s.style.display=n}}function getSelectedValue(e,t){return t=null==t?document:t,null==t.getElementById(e)?void console.error(UI.Err+": "+e+" "+UI.nex):(selectedIndex=t.getElementById(e).selectedIndex,selectedValue="",selectedIndex>=0&&(selectedValue=t.getElementById(e).options[t.getElementById(e).selectedIndex].value),selectedValue)}function setAllowableSelections(e,t,a,n){null==n&&(n=document);var o=n.getElementById(e);if(null!=a&&null!=t&&null!=o){var s=!0;if(t.length==o.options.length)for(s=!1,optionIndex=0;optionIndex<o.options.length&&!s;optionIndex++)s=s||o.options[optionIndex].text!=a[optionIndex]||o.options[optionIndex].value!=t[optionIndex];if(s){for(currentSelection=getSelectedValue(e,n),removeAllOptionsFromSelectElement(o),addIndex=0;addIndex<t.length;addIndex++)addOptionToSelectElement(e,a[addIndex],t[addIndex],null,n);setSelectedValue(e,currentSelection,n)}}}function removeAllOptionsFromSelectElement(e){for(;e.length>0;)try{e.remove(0)}catch(t){}}function addOptionToSelectElement(e,t,a,n,o){o=null==o?document:o,option=o.createElement("option"),option.text=t,option.value=a;try{o.getElementById(e).add(option,n)}catch(s){null==n?o.getElementById(e).add(option):o.getElementById(e).add(option,n.index)}}function parseBytes(e,t,a,n){var o;return t="KBytes"!=t&&"MBytes"!=t&&"GBytes"!=t&&"TBytes"!=t?"mixed":t,spcr=null==a||0==a?" ":"",o="mixed"==t&&e>1099511627776||"TBytes"==t?(e/1099511627776).toFixed(n||3)+spcr+(a?UI.TB:UI.TBy):"mixed"==t&&e>1073741824||"GBytes"==t?(e/1073741824).toFixed(n||3)+spcr+(a?UI.GB:UI.GBy):"mixed"==t&&e>1048576||"MBytes"==t?(e/1048576).toFixed(n||3)+spcr+(a?UI.MB:UI.MBy):(e/1024).toFixed(n||3)+spcr+(a?UI.KB:UI.KBy)}function createInput(e,t){t=null==t?document:t;try{inp=t.createElement("input"),inp.type=e}catch(a){inp=t.createElement('<input type="'+e+'" />')}return inp.outerHTML}function textListToSpanElement(e,t,a){t=null!=t&&t,a=null==a?document:a;var n,o=a.createElement("span");for(n=0;n<e.length;n++)n>0&&o.appendChild(a.createElement("br")),o.appendChild(a.createTextNode(e[n]+(n<e.length-1&&t?",":"")));return o.innerHTML}function truncateDecimal(e){return result=""+Math.floor(1e3*e)/1e3,decMatch=result.match(/.*\.(.*)$/),null==decMatch?result+=".000":1==decMatch[1].length?result+="00":2==decMatch[1].length&&(result+="0"),result}function refreshTableData(e){e=null==e?"pcts":e;var t=(uciOriginal.getAllSectionsOfType(pkg,"quota"),[]),a=[];0==e.localeCompare("usds")?a=allQuotaUsed:0==e.localeCompare("lims")?a=allQuotaLimits:0==e.localeCompare("pcts")&&(a=allQuotaPercents);var n;for(n=0;n<allQuotaIds.length;n++){var o,s=allQuotaIds[n],i=allQuotaIps[s],r=idToTimeParams[s],d=!1;for(o=0;o<i.length;o++){var l=i[o],u="N/A",p="N/A",c="N/A";if(null!=a[s]&&null!=a[s][l]){var _=a[s][l],m=allQuotaUsed[s][l],h=m[0]<=0&&m[1]<=0&&m[2]<=0;d=h&&0==s.localeCompare("ALL_OTHERS_INDIVIDUAL"),0==e.localeCompare("pcts")?(c=_[0]>=0?percentColorSpan(_[0]):c,p=_[1]>=0?percentColorSpan(_[1]):p,u=_[2]>=0?percentColorSpan(_[2]):u):(c=_[0]>=0?parseBytes(_[0]):c,p=_[1]>=0?parseBytes(_[1]):p,u=_[2]>=0?parseBytes(_[2]):u)}ipList=l.split(/[\t ]*,[\t ]*/),hostList=getHostList(ipList),d||t.push([textListToSpanElement(hostList,!0,document),timeParamsToTableSpan(r),c,p,u])}}var g=createUsageTrs(t);$("#active_quota_container").empty().append(g),g||$("#active_quota_container").append('<tr><td colspan="5">'+UI.No_Active_Quota+".</td></tr>"),Ha.setFooterPosition()}function updateTableData(){if(!updateInProgress){updateInProgress=!0;var stateChangeFunction=function(data){for(var text=data.split(/[\r\n]+/),next="";text.length>0&&"Success"!=next;)next=text.pop();eval(text.join("\n")),allQuotaIds=quotaIdList,allQuotaIps=quotaIpLists,allQuotaUsed=quotaUsed,allQuotaLimits=quotaLimits,allQuotaPercents=quotaPercents,refreshTableData($("#data_display").val()),updateInProgress=!1};$.post("/","app=quotas&action=quotas_status",stateChangeFunction)}}function getIdFromIp_usage(e,t){id=""==e?"ALL":e.replace(/[\t, ]+.*$/,""),id=id.replace(/\//,"_");for(var a=id,n=!0,o=0,s=t.getAllSectionsOfType(pkg,"quota");n;){n=!1;var i;for(i=0;i<s.length&&!n;i++)n=n||t.get(pkg,s[i],"id")==id;if(n){var r="ABCDEFGHIJKLMNOPQRSTUVWXYZ",d=o<26?"_"+r.substr(o,1):"_Z"+(o-25);id=a+d}o++}return id}function getIpFromUci(e,t){var a=e.get(pkg,t,"ip");return"ALL_OTHERS_INDIVIDUAL"==a?a=quotasStr.OthersOne:"ALL_OTHERS_COMBINED"==a?a=quotasStr.OthersAll:"ALL"!=a&&""!=a||(a=quotasStr.All),a}function percentColorSpan(e){if(span=document.createElement("span"),text=null,color="black",null!=e){text=document.createTextNode(e+"%");var t=function(e){var t=parseInt(e).toString(16).toUpperCase();return t=t.length<2?"0"+t:t.substr(0,2)};color=e>=100?"#AA0000":"",color=e>=50&&e<100?"#AA"+t(170-170*((e-50)/50))+"00":color,color=e>=0&&e<50?"#"+t(170*e/50)+"AA00":color,color=e<=0?"#00AA00":color,span.style.color=color}return span.appendChild(text),span.outerHTML}function getHostList(e){var t=[],a=0;for(a=0;a<e.length;a++)t.push(getHostDisplay(e[a]));return t}function getHostDisplay(e){var t=getSelectedValue("host_display"),a=e;return"hostname"==t&&null!=ipToHostname[e]&&(a=ipToHostname[e],a=a.length<25?a:a.substr(0,22)+"..."),a}$("#applies_to_type").change(alterApplyto),$("#max_up_type").change(function(){alterLimitInput("max_up_type","max_up","max_up_unit")}),$("#max_down_type").change(function(){alterLimitInput("max_down_type","max_down","max_down_unit")}),$("#max_combined_type").change(function(){alterLimitInput("max_combined_type","max_combined","max_combined_unit")}),$("#quota_reset").change(alterQuoteaReset),$("#quota_active").change(alterQuotaActive),$("#quota_active_type").change(alterQuotaActiveType),$("#quota_exceeded").change(function(){alterQuotaExceeded(),disableSaveBtn()}),$("#add_ip").focus(function(){$("#add_ip_help").removeClass("hidden").html(UI.Specify_an_IP_or_IP_range),$("#add_ip_input").removeClass("has-error")}),$("#add_ip").bind("keyup blur",function(){checkIPs(),disableSaveBtn()}),$(".add_ip_btn").click(function(){var e=addAddressesToTable(document,"add_ip","ip_span_container","quota_ip_table",!1,3,!1,!0);return e||($("#add_ip").focus(),$("#add_ip_input").addClass("has-error"),$("#add_ip_help").html("<span>"+UI.There_is_invalid_IP_or_IP_range_Exists+".</span>")),!1}),$("#add_quota_btn").click(function(){$("#save_quota").html(UI.Add).attr("data-type","add"),setDocumentFromUci(document,new UCIContainer,""),disableSaveBtn()}),$("#save_quota").click(function(){var e=$(this).attr("data-type");if("edit"==e){var t=$(this).attr("data-id");saveEdited(t)}else addNewQuota()}),$("#max_up,#max_down,#max_combined").bind("blur keyup change",function(){checkMax($(this)),disableSaveBtn()}),$("#max_up_type,#max_down_type,#max_combined_type").bind("change",function(){validateMaxAll(),disableSaveBtn()}),$("#active_hours").bind("keyup blur",function(){checkHours(),disableSaveBtn()}),$("#active_weekly").bind("keyup blur",function(){checkWeekly(),disableSaveBtn()}),$("#quota_qos_up,#quota_qos_down").bind("keyup blur",function(){checkQos($(this)),disableSaveBtn()}),fullQosEnabled?$("#quota_exceeded").find('[value="combined"]').removeClass("hidden"):$("#quota_exceeded").find('[value="combined"]').addClass("hidden"),UI.Reset="Reset",UI.Clear="Clear History",UI.Delete="Delete Data",UI.DNow="Download Now",UI.Visited="Visited Sites",UI.Requests="Search Requests",UI.DDNSService="DDNS Service",UI.WakeUp="Wake Up",UI.NewRule="Add New Rule",UI.NewQuota="Add New Quota",UI.AddRule="Add Rule",UI.AddSvcCls="Add Service Class",UI.Select="Select",UI.ChPRoot="Change Plugin Root",UI.AddPSource="Add Plugin Source",UI.Uninstall="Uninstall",UI.Install="Install",UI.RefreshPlugins="Refresh Plugins",UI.GetBackup="Get Backup Now",UI.RestoreConfig="Restore Configuration Now",UI.RestoreDefault="Restore Default Configuration Now",UI.Upgrade="Upgrade Now",UI.Reboot="Reboot Now",UI.MoreInfo="More Info",UI.Hide="Hide Text",UI.WaitSettings="Please wait while new settings are applied…",UI.Wait="Please wait…",UI.ErrChanges="Changes could not be applied",UI.Disabled="Disabled",UI.Enabled="Enabled",UI.unk="unknown",UI.HsNm="Hostname",UI.HDsp="Host Display",UI.DspHn="Display Hostnames",UI.DspHIP="Display Host IPs",UI.never="never",UI.disabled="disabled",UI.both="both",UI.seconds="seconds",UI.minutes="minutes",UI.hours="hours",UI.days="days",UI.second="second",UI.minute="minute",UI.hour="hour",UI.day="day",UI.month="month",UI.year="year",UI.sc="s",UI.hr="hr",UI.pAM="",UI.pPM="",UI.EMonths=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],UI.byt="bytes",UI.Bu="B",UI.KB="kB",UI.MB="MB",UI.GB="GB",UI.TB="TB",UI.KB1="kByte",UI.MB1="MByte",UI.GB1="GByte",UI.TB1="TByte",UI.KBy="kBytes",UI.MBy="MBytes",UI.GBy="GBytes",UI.TBy="TBytes",UI.Kbs="kbits/s",UI.KBs="kBytes/s",UI.MBs="MBytes/s",UI.CApplyChanges="Close and Apply Changes",UI.CDiscardChanges="Close and Discard Changes",UI.waitText="Please Wait While Settings Are Applied",UI.Cancel="Cancel",UI.Err="ERROR",UI.prfErr="There is an error in",UI.nex="does not exist",UI.InvAdd="ERROR: Invalid Address",UI.CPass="Confirm Password",UI.OK="OK",UI.VPass="Verifying Password...",UI.sprt="SSH port",UI.wsprt="web server port",UI.prdr="port redirected to router",UI.puse="port in use by router",UI.pfwd="port forwarded to",UI.conn="connected",UI.AJAX="AJAX Browser Support Needed",UI.AJAXUpg="Please upgrade to an AJAX compatible browser and try again. Such browsers include Firefox 2.0+, Safari and IE 6+.",quotasStr.AppliesTo="Applies to",quotasStr.QLocalNet="Entire Local Network",quotasStr.QOnlyHosts="Only the following Host(s)",quotasStr.HostsWithoutQuotas="All Individual Hosts Without Explicit Quotas",quotasStr.ComboHostsWithoutQuotas="All Hosts Without Explicit Quotas (Combined)",quotasStr.IPorRange="Specify an IP or IP range",quotasStr.MaxUp="Max Upload",quotasStr.MaxDown="Max Download",quotasStr.MaxUpDown="Max Total Up+Down",quotasStr.Unlimited="Unlimited",quotasStr.Limited="Limit to",quotasStr.QResets="Quota Resets",quotasStr.EvHour="Every Hour",quotasStr.EvDay="Every Day",quotasStr.EvWeek="Every Week",quotasStr.EvMonth="Every Month",quotasStr.ResetDay="Reset Day",quotasStr.ResetHour="Reset Hour",quotasStr.QuotaActive="Quota Is Active",quotasStr.TheseHours="These Hours",quotasStr.TheseDays="These Days",quotasStr.TheseDaysHours="These Days &amp; Hours",quotasStr.TheseTimes="These Weekly Times",quotasStr.Sample="e.g. Mon 00:30 - Thu 13:15, Fri 14:00 - Fri 15:00",quotasStr.SSample="e.g.",quotasStr.Exceed="When Exceeded",quotasStr.ShutdownNet="Shut Down All Internet Access",quotasStr.Throttle="Throttle Bandwidth",quotasStr.UpLimit="Upload Limit",quotasStr.DownLimit="Download Limit",quotasStr.UpClass="Upload Class",quotasStr.DownClass="Download Class",quotasStr.ESection="Edit Quota",quotasStr.USect="Bandwidth Quota Usage",quotasStr.All="All",quotasStr.Alws="Always",quotasStr.ColNms=["Host(s)","Active","% Total Used","% Down Used","% Up Used"];var TSort_Data=new Array("quota_table","s","s","m",""),pkg="quotas_uci",changedIds=[],rowCheckIndex=3,downQosClasses=[],downQosMarks=[],upQosClasses=[],upQosMarks=[],table_data=[],form_data=[],updateInProgress=!1,allQuotaIds,allQuotaIps,allQuotaUsed,allQuotaLimits,allQuotaPercents,idToSection=[],idToIpStr=[],idToTimeParams=[];resetData();