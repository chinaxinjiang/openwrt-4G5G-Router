function initializeConnectionTable(){httpsPort=getHttpsPort(),httpPort=getHttpPort(),setSelectedValue("host_display","hostname"),remoteHttpsPort="",remoteHttpPort="";var t=uciOriginal.getAllSectionsOfType("firewall","remote_accept"),e=0;for(e=0;e<t.length;e++){var o=t[e],n=uciOriginal.get("firewall",o,"local_port"),r=uciOriginal.get("firewall",o,"remote_port"),a=uciOriginal.get("firewall",o,"proto").toLowerCase(),s=uciOriginal.get("firewall",o,"zone").toLowerCase();"wan"!=s&&""!=s||"tcp"!=a&&""!=a||(r=""==r?n:r,n==httpsPort&&""!=n?remoteHttpsPort=r:n==httpPort&&""!=n&&(remoteHttpPort=r))}var l=0;for(l=0;l<qosMarkList.length;l++){var i=parseInt(qosMarkList[l][3].toLowerCase());qosUpMask="upload"==qosMarkList[l][0]?i:qosUpMask,qosDownMask="download"==qosMarkList[l][0]?i:qosDownMask,markToQosClass[parseInt(qosMarkList[l][2])]=qosMarkList[l][1]}updateInProgress=!1,timeSinceUpdate=-5e3,setInterval("checkForRefresh()",500)}function checkForRefresh(){timeSinceUpdate+=500,refreshRate=getSelectedValue("refresh_rate"),refreshRate="never"==refreshRate?timeSinceUpdate+500:refreshRate,(timeSinceUpdate<0||timeSinceUpdate>=refreshRate)&&(timeSinceUpdate=0,updateConnectionTable())}function getHostDisplay(t){var e=getSelectedValue("host_display"),o=t;return"hostname"==e&&null!=ipToHostname[t]&&(o=ipToHostname[t],o=o.length<25?o:o.substr(0,22)+"..."),o}function updateConnectionTable(){if(!updateInProgress){updateInProgress=!0;var t=function(t){var e,o=getSelectedValue("bw_units"),n=t.split(/[\n\r]+/),r=new Array;for(e=0;null==n[e].match(/^Success/);e++){var a=n[e];try{var s=a.split(/[\t ]+/)[2],l=a.match(/src=([^ \t]*)[\t ]+/)[1],i=a.match(/sport=([^ \t]*)[\t ]+/)[1],c=a.match(/dst=([^ \t]*)[\t ]+/)[1],p=(a.match(/dport=([^ \t]*)[\t ]+/)[1],a.match(/bytes=([^ \t]*)[\t ]+/)[1]),d=a.match(/mark=/)?parseInt(a.match(/mark=([^ \t]*)[\t ]+/)[1]):"",u=a.match(/l7proto=/)?a.match(/l7proto=([^ \t]*)[\t ]+/)[1]:"",h=a.match(/src=([^ \t]*)[\t ]+.*src=([^ \t]*)[\t ]+/)[2],m=a.match(/sport=([^ \t]*)[\t ]+.*sport=([^ \t]*)[\t ]+/)[2],g=a.match(/dst=([^ \t]*)[\t ]+.*dst=([^ \t]*)[\t ]+/)[2],y=a.match(/dport=([^ \t]*)[\t ]+.*dport=([^ \t]*)[\t ]+/)[2],I=a.match(/bytes=([^ \t]*)[\t ]+.*bytes=([^ \t]*)[\t ]+/)[2],f=!0;if(g==currentWanIp?(downloadBytes=I,uploadBytes=p,localIp=l,localPort=i,WanIp=h,WanPort=m):c==currentWanIp?(downloadBytes=p,uploadBytes=I,localIp=h,localPort=m,WanIp=g,WanPort=y):f=!1,f){var v=[parseInt(uploadBytes)+parseInt(downloadBytes),s,getHostDisplay(WanIp)+":"+WanPort+"<br>"+getHostDisplay(localIp)+":"+localPort,'<span class="glyphicon glyphicon-arrow-up"></span>'+parseBytes(uploadBytes,o)+'<br><span class="glyphicon glyphicon-arrow-down"></span>'+parseBytes(downloadBytes,o)];if(qosEnabled){var P=function(t,e){var o=""==t?"":markToQosClass[t&e],n=uciOriginal.get("qos_shellgui",o,"name");return""==n?"NA":n};v.push('<span class="glyphicon glyphicon-arrow-up"></span>'+P(qosUpMask,d)+'<br><span class="glyphicon glyphicon-arrow-down"></span>'+P(qosDownMask,d))}v.push(u),r.push(v)}}catch(w){}}var B=function(t,e){return parseInt(e[0])-parseInt(t[0])};r.sort(B);var k;for(k=0;k<r.length;k++)r[k].shift();var T=[connTS.PrNm,connTS.WLNm,connTS.UDNm];qosEnabled&&T.push(connTS.QSNm),T.push(connTS.LPNm);var U=createTr(r);$("#links_container").empty(),$("#links_container").parent().find("thead").removeClass("hidden"),$("#links_container").append(U),Ha.setFooterPosition(),$(".loading").addClass("hidden"),updateInProgress=!1};$.post("/","app=conntrack&action=get_nf_conntrack",t)}}function createTr(t){for(var e="",o=0;o<t.length;o++){var n='<tr class="text-left"><td>'+t[o][0]+"</td><td>"+t[o][1]+"</td><td>"+t[o][2]+"</td><td>"+t[o][3]+"</td><td>"+t[o][4]+"</td></tr>";e+=n}return e}function getHttpsPort(t){return getUhttpServerPort(!0,"main",t)}function getHttpPort(t){return getUhttpServerPort(!1,"main",t)}function getUhttpServerPort(t,e,o){o=null==o?uciOriginal:o;var n,r=o.get("uhttpd",e,t?"listen_https":"listen_http"),a="";for(n=0;n<r.length;n++){var s=r[n];s.match(/^0\.0\.0\.0:/)&&(a=s.replace(/^.*:/,""))}return a}function setBrowserTimeCookie(){var t=Math.floor((new Date).getTime()/1e3);document.cookie="browser_time="+t+"; path=/"}function setSelectedValue(t,e,o){var o=null==o?document:o,n=o.getElementById(t);null==n&&console.log("Error.");var r=!1;for(optionIndex=0;optionIndex<n.options.length&&!r;optionIndex++)r=n.options[optionIndex].value==e,r&&(n.selectedIndex=optionIndex);!r&&n.options.length>0&&n.selectedIndex<0&&(n.selectedIndex=0)}function getSelectedValue(t,e){return e=null==e?document:e,null==e.getElementById(t)?void alert(UI.Err+": "+t+" "+UI.nex):(selectedIndex=e.getElementById(t).selectedIndex,selectedValue="",selectedIndex>=0&&(selectedValue=e.getElementById(t).options[e.getElementById(t).selectedIndex].value),selectedValue)}function getParameterDefinition(t,e){return encodeURIComponent(t)+"="+encodeURIComponent(e)}function getRequestObj(){var t;try{t=new XMLHttpRequest}catch(e){try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}}}return t}function parseBytes(t,e,o,n){var r;return e="KBytes"!=e&&"MBytes"!=e&&"GBytes"!=e&&"TBytes"!=e?"mixed":e,spcr=null==o||0==o?" ":"",r="mixed"==e&&t>1099511627776||"TBytes"==e?(t/1099511627776).toFixed(n||3)+spcr+(o?UI.TB:UI.TBy):"mixed"==e&&t>1073741824||"GBytes"==e?(t/1073741824).toFixed(n||3)+spcr+(o?UI.GB:UI.GBy):"mixed"==e&&t>1048576||"MBytes"==e?(t/1048576).toFixed(n||3)+spcr+(o?UI.MB:UI.MBy):(t/1024).toFixed(n||3)+spcr+(o?UI.KB:UI.KBy)}var connTS=new Object,updateInProgress,timeSinceUpdate,httpsPort="",httpPort="",remoteHttpsPort="",remoteHttpPort="",qosUpMask="",qosDownMask="",markToQosClass=[];setBrowserTimeCookie(),initializeConnectionTable();