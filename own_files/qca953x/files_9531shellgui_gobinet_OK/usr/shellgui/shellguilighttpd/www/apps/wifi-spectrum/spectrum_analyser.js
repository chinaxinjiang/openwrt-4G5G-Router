function initialiseAll(){var e=[],t=[];if(interfaces=parseInterfaces(wifiLines),interfaces!=-1){for(var n=0;n<interfaces.length;n++)e.push(interfaces[n][0]),t.push(interfaces[n][0]+" "+interfaces[n][1]);setAllowableSelections("interface",e,t),changeBand()}}function initialisePlots(){band=interfaces[document.getElementById("interface").selectedIndex][1],"2.4GHz"==band?(freq_low=2.4,freq_high=2.5):(freq_low=5.165,freq_high=5.84)}function changeBand(){var e=$("#interface").val(),t=$('[value="'+e+'"]').html();t.indexOf("2.4")>-1?$("#sm-range,#xs-range").addClass("hidden"):$("#sm-range,#xs-range").removeClass("hidden"),initialisePlots(),getWifiData()}function parseInterfaces(e){if(0==e.length)return-1;var t=[];for(lineIndex=0,lineIndex=0;lineIndex<e.length;lineIndex++){var n=e[lineIndex],a=n.split(" "),r=a[0].indexOf("-");if(r==-1){var l=a[0];if(a[1]>14)var s="5GHz";else var s="2.4GHz";t.push([l,s])}}return t}function getWifiData(){Ha.mask.show();var e=[],t=$("#interface").val(),n="app=wifi-spectrum&action=get_scan&dev="+t,a=function(n){var a=n.replace(/Success/,"");if(a=a.replace(/\"/g,""),e=parseWifiData(a),e==-1)Ha.mask.hide(),$("#canvas").remove(),Ha.showNotify({status:1,msg:UI.There_does_not_have_any_SSID});else{Ha.mask.hide();var r=$('[value="'+t+'"]').html();r=r.indexOf("2.4")>-1?2.4:5;var l=getPointsData(e);createLines(l,r)}$("#footer").removeClass("absolute")};$.post("/",n,a)}function getPointsData(e){var t=[],n=4,a=12;if("2.4GHz"==band)for(x=0;x<e[0].length;x++){var r=e[0][x],l=e[1][x],s=e[2][x],d=e[3][x];t[x]={ssid:r,level:parseInt(d),channel:parseInt(l),secondary:s};var i=gband[0].indexOf(parseInt(l));t[x].freq=gband[1][i],"no secondary"==s&&(t[x].lowfreq=getfreqData(l,2),t[x].highfreq=getfreqData(l,3)),"above"==s&&(t[x].lowfreq=getfreqData(l,2),t[x].highfreq=getfreqData(l- -n,3)),"below"==s&&(t[x].lowfreq=getfreqData(l-n,2),t[x].highfreq=getfreqData(l,3)),t[x].channel_low=t[x].channel-(1e3*t[x].freq-1e3*t[x].lowfreq-1)/5,t[x].channel_high=t[x].channel+(1e3*t[x].highfreq-1-1e3*t[x].freq)/5}else if("5GHz"==band)for(x=0;x<e[0].length;x++){var r=e[0][x],l=e[1][x],s=e[2][x],d=e[3][x],o=e[4][x];t[x]={ssid:r,level:parseInt(d),channel:parseInt(l),secondary:s};var i=aband[0].indexOf(parseInt(l));t[x].freq=aband[1][i],"no secondary"==s&&(t[x].lowfreq=getfreqData(l,2),t[x].highfreq=getfreqData(l,3)),"above"==s&&(o?(t[x].lowfreq=getfreqData(l,2),t[x].highfreq=getfreqData(l- -a,3)):(t[x].lowfreq=getfreqData(l,2),t[x].highfreq=getfreqData(l- -n,3))),"below"==s&&(t[x].lowfreq=getfreqData(l-n,2),t[x].highfreq=getfreqData(l,3)),t[x].channel_low=t[x].channel-2*(100*t[x].freq-100*t[x].lowfreq),t[x].channel_high=t[x].channel+2*(100*t[x].highfreq-100*t[x].freq)}else t=-1;legendCount=t.length;var c=parsePoints(t);return c}function parsePoints(e){for(var t=[],n=0;n<e.length;n++){var a={};a.channel=e[n].channel,e[n].ssid.indexOf("\\x")>-1&&(e[n].ssid=e[n].ssid.replace(/\\x/g,"%"),e[n].ssid=e[n].ssid.replace(/%00/g,""),e[n].ssid=decodeURI(e[n].ssid)),a.label=e[n].ssid?e[n].ssid:UI.Unknow_device,a.lowfreq=e[n].lowfreq,a.highfreq=e[n].highfreq,a.freq=e[n].freq,a.level=parseInt(e[n].level)>=-100?parseInt(e[n].level):-100,a.data=[];var r=e[n].channel_low,l=e[n].channel_high;a.data[0]={x:r,y:0},a.data[1]={x:a.channel,y:a.level+100},a.data[2]={x:l,y:0},t.push(a)}return t}function createLines(e,t){var n={datasets:e},a={label:"",data:[{x:-2,y:100},{x:16,y:0}]};n.datasets.push(a);var r=function(e,t){var n=randomColor(.6);t.borderColor=n,t.backgroundColor=randomColor(.1,n),t.pointBorderColor=randomColor(.7,n),t.pointBackgroundColor=randomColor(.5,n),t.pointBorderWidth=1,""==t.label&&(t.pointBorderColor="transparent",t.pointBackgroundColor="transparent",t.pointBorderWidth=0,t.borderColor="transparent",t.backgroundColor="transparent")};if($.each(n.datasets,r),$("#line_container").empty(),$(".chartjs-hidden-iframe").remove(),2.4==t){console.log(n),$("#line_container").append('<canvas id="canvas"></canvas>');var l=document.getElementById("canvas").getContext("2d"),s=$(window).width();s<=768&&$("#line_container").find("canvas").prop("height",360+12*legendCount),window.myScatter=Chart.Scatter(l,setConfig(n,[1,2,3,4,5,6,7,8,9,10,11,12,13,16],-2,16,1,setTick2_4,"2401-2495 MHz"))}else if(5==t){n.datasets.pop();for(var d,i,o,c={datasets:[]},f={datasets:[]},g={datasets:[]},h=0;h<n.datasets.length;h++)n.datasets[h].channel<100?c.datasets.push(n.datasets[h]):n.datasets[h].channel<149?f.datasets.push(n.datasets[h]):g.datasets.push(n.datasets[h]);for(var x=0;x<g.datasets.length;x++)for(var u=0;u<g.datasets[x].data.length;u++)g.datasets[x].data[u].x-=1;d=c.datasets.length,i=f.datasets.length,o=g.datasets.length;var p=Math.max(d,i,o);$("#5g_1_btn").find(".badge").html(d||""),$("#5g_2_btn").find(".badge").html(i||""),$("#5g_3_btn").find(".badge").html(o||""),$("#xs-range").find('[value="5g_1"]').html("5170-5330 ("+d+")"),$("#xs-range").find('[value="5g_2"]').html("5490-5710 ("+i+")"),$("#xs-range").find('[value="5g_3"]').html("5735-5835 ("+o+")"),c.datasets.push({label:"",data:[{x:36,y:100},{x:64,y:0}]}),f.datasets.push({label:"",data:[{x:96,y:100},{x:142,y:0}]}),g.datasets.push({label:"",data:[{x:145,y:100},{x:167,y:0}]}),$.each(c.datasets,r),$.each(f.datasets,r),$.each(g.datasets,r),$("#line_container").append('<canvas id="5g_1"></canvas><canvas id="5g_2"></canvas><canvas id="5g_3"></canvas>');var s=$(window).width();s<=768&&$("#line_container").find("canvas").prop("height",360+12*legendCount);var v=document.getElementById("5g_1").getContext("2d"),m=document.getElementById("5g_2").getContext("2d"),I=document.getElementById("5g_3").getContext("2d");window.Scatter_5g1=Chart.Scatter(v,setConfig(c,[36,40,44,48,52,56,60,64],32,72,4,setTick,"5170-5330 MHz")),window.Scatter_5g2=Chart.Scatter(m,setConfig(f,[100,104,108,112,116,120,124,128,132,136,140],96,142,4,setTick,"5490-5710 GHz")),window.Scatter_5g3=Chart.Scatter(I,setConfig(g,[148,152,156,160,164],144,168,4,setTick3,"5735-5835 GHz")),changeRange(d==p?1:i==p?2:3)}}function changeRange(e){$("#5g_2,#5g_3,#5g_1").addClass("hidden"),$("#5g_"+e).removeClass("hidden"),$("#sm-range").find(".btn").removeClass("active"),$("#5g_"+e+"_btn").addClass("active"),$("#xs-range").val("5g_"+e)}function setConfig(e,t,n,a,r,l,s){var d={type:"line",data:e,options:{title:{display:!0,text:s},tooltips:{enabled:!0,callbacks:{label:function(e,t){return setLabel(e,t)}}},scales:{xAxes:[{position:"bottom",ticks:{autoSkip:!1,min:n,max:a,stepSize:r,userCallback:function(e){var n=t;return l(e,n)}},scaleLabel:{display:!0,labelString:UI.Wireless_channel__GHz,fontSize:14}}],yAxes:[{position:"left",ticks:{userCallback:function(e){return setTicky(e)}},scaleLabel:{display:!0,labelString:UI.Signal_strength__dBm,fontSize:14}}]}}};return d}function setTick2_4(e,t){return t.indexOf(e)<0?"":16==e?14:e}function setTick(e,t){return t.indexOf(e)>=0?e:""}function setTick3(e,t){return t.indexOf(e)>=0?e+1:""}function setTicky(e){return 100==e?"":e-100}function setLabel(e,t){var n,a=[],r=t.datasets[e.datasetIndex].label,l="level: "+t.datasets[e.datasetIndex].level+"dBm",s="channel: "+t.datasets[e.datasetIndex].channel;return n=0==e.index?"lowfreq: "+t.datasets[e.datasetIndex].lowfreq+"MHz":1==e.index?"freq: "+t.datasets[e.datasetIndex].freq+"MHz":"highfreq: "+t.datasets[e.datasetIndex].highfreq+"MHz",a.push(r),a.push(l),a.push(s),a.push(n),""==r?"":a}function randomColor(e,t){if("undefined"==typeof t)return"rgba("+Math.round(255*Math.random())+","+Math.round(255*Math.random())+","+Math.round(255*Math.random())+","+(e||".3")+")";var n=t.split(",");return n[3]=e+")",n.join(",")}function parseWifiData(e){if(null!=e&&0!=e.indexOf("\n")&&0!=e.indexOf("\r")){var t=[[],[],[],[],[]],n=e.split(/BSS [A-Fa-f0-9]{2}[:]/g);n.shift();for(var a=function(e,t){var n,a=[];for(n=0;n<t.length;n++){var r=t[n],l=r.indexOf(e),s=r.indexOf(":"),d=r.indexOf("="),i=s;if((i<0||d>=0&&d<i)&&(i=d),l>=0&&i>l){var o=r.substr(i+1);o=o.replace(/^[^\"]*\"/g,""),o=o.replace(/\".*$/g,""),o=o.replace(/^[ ]/g,""),o=o.replace(/ dBm/g,""),o=o.replace(/channel /g,""),a.push(o)}}return a};n.length>0;){var r=n.shift(),l=r.split(/[\r\n]+/),s=a("SSID",l).shift(),d=a("DS Parameter set",l).shift(),i=a("secondary channel offset",l).shift(),o=a("signal",l).shift(),c=a("* channel width",l).shift();if(!d)var d=a("* primary channel",l).shift();i||(i="no secondary"),null!=s&&null!=d&&null!=i&&null!=o&&(t[0].push(s),t[1].push(d),t[2].push(i),t[3].push(o),t[4].push(c))}for(x=0;x<t[0].length;x++){for(append=2,y=x+1;y<t[0].length;y++)t[0][x]==t[0][y]&&(t[0][y]=t[0][y]+"_"+append,append+=1);append>2&&(t[0][x]=t[0][x]+"_1")}return t}return-1}function getfreqData(e,t){return e>14?(a=aband[0].indexOf(parseInt(e)),aband[t][a]):(a=gband[0].indexOf(parseInt(e)),gband[t][a])}function setAllowableSelections(e,t,n,a){null==a&&(a=document);var r=a.getElementById(e);if(null!=n&&null!=t&&null!=r){var l=!0;if(t.length==r.options.length)for(l=!1,optionIndex=0;optionIndex<r.options.length&&!l;optionIndex++)l=l||r.options[optionIndex].text!=n[optionIndex]||r.options[optionIndex].value!=t[optionIndex];if(l){for(currentSelection=getSelectedValue(e,a),removeAllOptionsFromSelectElement(r),addIndex=0;addIndex<t.length;addIndex++)addOptionToSelectElement(e,n[addIndex],t[addIndex],null,a);setSelectedValue(e,currentSelection,a)}}}function getSelectedValue(e,t){return t=null==t?document:t,null==t.getElementById(e)?void alert("Error: "+e+" Not Existes"):(selectedIndex=t.getElementById(e).selectedIndex,selectedValue="",selectedIndex>=0&&(selectedValue=t.getElementById(e).options[t.getElementById(e).selectedIndex].value),selectedValue)}function removeAllOptionsFromSelectElement(e){for(;e.length>0;)try{e.remove(0)}catch(t){}}function addOptionToSelectElement(e,t,n,a,r){r=null==r?document:r,option=r.createElement("option"),option.text=t,option.value=n;try{r.getElementById(e).add(option,a)}catch(l){null==a?r.getElementById(e).add(option):r.getElementById(e).add(option,a.index)}}function setSelectedValue(e,t,n){var n=null==n?document:n,a=n.getElementById(e),r=!1;for(optionIndex=0;optionIndex<a.options.length&&!r;optionIndex++)r=a.options[optionIndex].value==t,r&&(a.selectedIndex=optionIndex);!r&&a.options.length>0&&a.selectedIndex<0&&(a.selectedIndex=0)}function getParameterDefinition(e,t){return encodeURIComponent(e)+"="+encodeURIComponent(t)}function getSelectedText(e,t){return t=null==t?document:t,selectedIndex=t.getElementById(e).selectedIndex,selectedText="",selectedIndex>=0&&(selectedText=t.getElementById(e).options[t.getElementById(e).selectedIndex].text),selectedText}var interfaces,freq_low,freq_high,detected,band,plotdata=[],legendCount,gband=[[1,2,3,4,5,6,7,8,9,10,11,12,13,14],[2.412,2.417,2.422,2.427,2.432,2.437,2.442,2.447,2.452,2.457,2.462,2.467,2.472,2.484],[2.401,2.406,2.411,2.416,2.421,2.426,2.431,2.436,2.441,2.446,2.451,2.456,2.461,2.473],[2.423,2.428,2.433,2.438,2.443,2.448,2.453,2.458,2.463,2.468,2.473,2.478,2.483,2.495]],aband=[[36,40,44,48,52,56,60,64,100,104,108,112,116,120,124,128,132,136,140,149,153,157,161,165],[5.18,5.2,5.22,5.24,5.26,5.28,5.3,5.32,5.5,5.52,5.54,5.56,5.58,5.6,5.62,5.64,5.66,5.68,5.7,5.745,5.765,5.785,5.805,5.825],[5.17,5.19,5.21,5.23,5.25,5.27,5.29,5.31,5.49,5.51,5.53,5.55,5.57,5.59,5.61,5.63,5.65,5.67,5.69,5.735,5.755,5.775,5.795,5.815],[5.19,5.21,5.23,5.25,5.27,5.29,5.31,5.33,5.51,5.53,5.55,5.57,5.59,5.61,5.63,5.65,5.67,5.69,5.71,5.755,5.775,5.795,5.815,5.835]];$("#xs-range").change(function(){console.log($(this).val());var e=$(this).val().replace("5g_","");changeRange(e)}),$("#sm-range").find(".btn").click(function(){var e=$(this).prop("id"),t=e.replace("5g_","").replace("_btn","");changeRange(t)}),initialiseAll();