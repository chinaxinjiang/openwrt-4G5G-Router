!function(){function a(t){console.log(t),$("#cl_roles_container").empty();for(var e=0;e<t.length;e++){var r=[];for(var s in t[e])if("Set_Service_Class_To"!=s&&"order"!=s){var l=UI[s]?UI[s]:s.replace(/_/g," ");r.push("<p>"+l+": "+t[e][s]+"</p>")}r.sort();var d=r.join(""),i=getClassName(t[e].Set_Service_Class_To,classes),n='<tr class="text-left" id="rule_num_'+t[e].order+'"><td>'+d+"</td><td>"+i+'</td><td><button class="btn btn-info btn-xs edit_rule_btn" data-data=\''+JSON.stringify(t[e])+'\' data-toggle="modal" data-target="#ruleModal">'+UI.Edit+'</button></td><td><button class="btn btn-danger btn-xs remove_rule_btn" data-order="order_'+t[e].order+'">'+UI.Remove+'</button></td><td><button class="btn btn-info btn-xs move_up_btn" data-order="order_'+t[e].order+'"><span class="icon-arrow-up"></span></button></td><td><button class="btn btn-info btn-xs move_down_btn" data-order="order_'+t[e].order+'"><span class="icon-arrow-down"></span></button></td></tr>';$("#cl_roles_container").append(n)}$(".edit_rule_btn").click(function(){$("#ruleModal").find(".modal-title").html(UI.Edit_QoS_Classification_Rule),$("#ruleModal").find(".has-error").removeClass("has-error"),$("#ruleModal").find(".help-block").addClass("hidden"),$("#rule_form").prop("name","editRuleForm"),$("#submit_rule_btn").prop("disabled",!1),resetForm("rule_form");var a=$(this).attr("data-data"),a=JSON.parse(a);for(var t in a){var e=$("#rule_form").find('[name="'+t+'"]');e.prop("disabled",!1),"order"!=t&&e.parent().parent().parent().find('[type="checkbox"]').prop("checked",!0),"text"==e.prop("type")||"hidden"==e.prop("type")?e.val(a[t]):(e.find("option").prop("selected",!1),e.find('[value="'+a[t]+'"]').prop("selected",!0))}}),$(".remove_rule_btn").click(function(){var t=$(this).attr("data-order").replace("order_","");rule_data=removeRule(t,rule_data),a(rule_data)}),$(".move_up_btn").click(function(){var t=parseInt($(this).attr("data-order").replace("order_",""));rule_data=moveRuleUp(t,rule_data),a(rule_data)}),$(".move_down_btn").click(function(){var t=parseInt($(this).attr("data-order").replace("order_",""));rule_data=moveRuleDown(t,rule_data),a(rule_data)})}function t(a){$("#service_class_container").empty();for(var e=0;e<a.length;e++){var r,s;r=a[e].min_bw?a[e].min_bw:"zero",s=a[e].max_bw?a[e].max_bw:"nolimit";var l='<tr class="text-left"><td>'+a[e].name+"</td><td>"+a[e].percent+"%</td><td>"+r+"</td><td>"+s+"</td><td>"+a[e].minRTT+'</td><td class="load_container" data-class="'+a[e]["class"]+'"></td><td><button class="btn btn-info btn-xs edit_class_btn" data-data=\''+JSON.stringify(a[e])+'\' data-toggle="modal" data-target="#classModal">'+UI.Edit+'</button></td><td><button class="btn btn-danger btn-xs remove_class_btn" data-name="'+a[e].name+'">'+UI.Remove+"</button></td></tr>";$("#service_class_container").append(l)}$(".load_container").each(function(a){for(var t=$(this).attr("data-class"),e=0;e<load.bps.length;e++)t-1==e&&$(this).html(bpsToKbpsString(load.bps[t-1]))}),$(".edit_class_btn").click(function(){$("#classModal").find(".modal-title").html(UI.Edit_QoS_Service_Class),$("#classModal").find(".help-block").addClass("hidden"),$("#classModal").find(".has-error").removeClass("has-error"),$("#class_form").attr("data-name","EditClassForm"),$("#submit_class_btn").prop("disabled",!1),resetForm("class_form");var a=$(this).attr("data-data"),a=JSON.parse(a);for(var t in a){var e=$("#class_form").find('[name="'+t+'"]');a[t]&&(e.val(a[t]),e.prop("disabled",!1),e.parent().parent().parent().find(".has_field").prop("checked",!0)),"radio"==e.prop("type")&&(e.prop("disabled",!1),a[t]?($("#rtt_yes").prop("checked",!0),$("#rtt_no").prop("checked",!1)):($("#rtt_yes").prop("checked",!1),$("#rtt_no").prop("checked",!0)))}}),$(".remove_class_btn").click(function(){var a=$(this).attr("data-name");service_class_data=removeSerClass(a,service_class_data),t(service_class_data)})}function e(){var t=$("#rule_form").serializeArray();t=formatData(t);for(var e=0;e<rule_data.length;e++)rule_data[e].order==t.order&&(rule_data[e]=t);a(rule_data)}function r(){var t=$("#rule_form").serializeArray(),e=formatData(t);return e.order=rule_data.length+1,rule_data.push(e),a(rule_data),!1}function s(){var a,e=$("#class_form").serializeArray();$("#class_form").find('[type="radio"]').each(function(){$(this).prop("checked")&&(a=$(this).attr("data-value"))});var r=formatData(e);return r.max_bw||(r.max_bw=0),r.min_bw||(r.min_bw=0),r.minRTT=a||"",service_class_data.push(r),t(service_class_data),!1}function l(){var a,e=$("#class_form").serializeArray();$("#class_form").find('[type="radio"]').each(function(){$(this).prop("checked")&&(a=$(this).attr("data-value"))}),e=formatData(e),e.max_bw||(e.max_bw=!1),e.min_bw||(e.min_bw=!1),e.minRTT=a;for(var r=0;r<service_class_data.length;r++)if(service_class_data[r].name===e.name){var s=service_class_data[r]["class"];service_class_data[r]=e,service_class_data[r]["class"]=s}return t(service_class_data),!1}function d(){$.post("/","app=qos-shellgui&action=get_qos_download",function(e){console.log(),origin_data=e.rule_data,rule_data=mapRuleData(origin_data),service_class_data=e.class_data,load=initLoadPbs(service_class_data),classes=getClassId(service_class_data),default_class=e.download_default_class,total_bw=e.download_total_bandwidth,ccstatus="true"==e.qos_monenabled,target_ip=e.ptarget_ip||"",ping_limit=e.pinglimit||"",a(rule_data),makeDefaultClass(classes,"down"),t(service_class_data),0==total_bw&&($("#page_switch").prop("checked",!1),$("input,button,select").prop("disabled",!0),$(".gotop-widget").find("button").prop("disabled",!1),$("#page_switch").prop("disabled",!1),clearInterval(updateLoadInterval)),ccstatus?i():n(),$("#default_class").find("option").each(function(){$(this).val()==default_class?$(this).prop("selected",!0):$(this).prop("selected",!1)}),$("#total_bw").val(total_bw)},"json")}function i(){$("#enable_cc").prop("checked",!0),$("#has_target_ip").prop("disabled",!1),$("#has_ping_limit").prop("disabled",!1),target_ip?($("#has_target_ip").prop("checked",!0),$("#target_ip").prop("disabled",!1).val(target_ip)):($("#has_target_ip").prop("checked",!1),$("#target_ip").prop("disabled",!0).val("")),ping_limit?($("#has_ping_limit").prop("checked",!0),$("#ping_limit").prop("disabled",!1).val(ping_limit)):($("#has_ping_limit").prop("checked",!1),$("#ping_limit").prop("disabled",!0).val("")),c()}function n(){$("#enable_cc").prop("checked",!1),$("#has_ping_limit").prop("checked",!1).prop("disabled",!0),$("#has_target_ip").prop("checked",!1).prop("disabled",!0),$("#congestion_control_form").find(".help-block").addClass("hidden"),$("#congestion_control_form").find(".has-error").removeClass("has-error"),$("#target_ip").prop("disabled",!0).val(target_ip),$("#ping_limit").prop("disabled",!0).val(ping_limit),c()}function o(a){var t=$("#enable_cc").prop("checked");if(!t)return!1;var e;e=a?!$("#has_target_ip").prop("checked"):$("#has_target_ip").prop("checked"),e?($("#has_target_ip").prop("checked",!1),$("#target_ip").prop("disabled",!0).val(target_ip||""),$("#target_ip").next(".help-block").addClass("hidden"),$("#target_ip").parent().parent().removeClass("has-error")):($("#has_target_ip").prop("checked",!0),$("#target_ip").prop("disabled",!1).focus().val(target_ip||""),target_ip||($("#target_ip").parent().parent().addClass("has-error"),$("#target_ip").next(".help-block").removeClass("hidden")))}function p(a){var t=$("#enable_cc").prop("checked");if(!t)return!1;var e;e=a?!$("#has_ping_limit").prop("checked"):$("#has_ping_limit").prop("checked"),e?($("#has_ping_limit").prop("checked",!1),$("#ping_limit").prop("disabled",!0).val(ping_limit||""),$("#ping_limit").parent().next(".help-block").addClass("hidden"),$("#ping_limit").parent().parent().removeClass("has-error")):($("#has_ping_limit").prop("checked",!0),$("#ping_limit").prop("disabled",!1).focus().val(ping_limit||""),ping_limit||($("#ping_limit").parent().parent().addClass("has-error"),$("#ping_limit").parent().next(".help-block").removeClass("hidden")))}function c(){var a=0;$("#congestion_control_form").find(".help-block").each(function(){$(this).hasClass("hidden")||(a+=1)}),$("#total_bw_help").hasClass("hidden")||(a+=1),a?$("#page_submit").prop("disabled",!0):$("#page_submit").prop("disabled",!1)}d(),updateLoadInterval=setInterval(function(){updateLoadData("down")},1e3),$("#page_submit").click(function(){Ha.mask.show();for(var a={app:"qos-shellgui",action:"set_download",rule_data:unmapRuleData(rule_data),class_data:service_class_data,download_total_bandwidth:$("#total_bw").val(),download_default_class:$("#default_class").val(),pinglimit:ccstatus?$("#ping_limit").val():"",ptarget_ip:ccstatus?$("#target_ip").val():"",qos_monenabled:ccstatus},t=0,e=0;e<a.class_data.length;e++)t+=parseInt(a.class_data[e].percent);return 100!=t?(Ha.mask.hide(),void Ha.showNotify({status:1,msg:UI.total_pct_warning})):(clearInterval(updateLoadInterval),void $.post("/",a,function(a){Ha.showNotify(a),function(){Ha.mask.hide()}(),d(),updateLoadInterval=setInterval(function(){updateLoadData("down")},1e3)},"json"))}),$("#page_switch").click(function(){var e=$(this).prop("checked");e?($("input,button,select").prop("disabled",!1),total_bw=3200,$("#total_bw").val(total_bw),$.post("/","app=qos-shellgui&action=total_bandwidth&up_down=download&total_bw=3200",Ha.showNotify,"json"),a(rule_data),makeDefaultClass(classes,"down"),t(service_class_data),updateLoadInterval=setInterval(function(){updateLoadData("down")},1e3)):($("input,button,select").prop("disabled",!0),$(".gotop-widget").find("button").prop("disabled",!1),total_bw=0,$("#total_bw").val(total_bw),$.post("/","app=qos-shellgui&action=total_bandwidth&up_down=download&total_bw=0",Ha.showNotify,"json"),clearInterval(updateLoadInterval)),$("#page_switch").prop("disabled",!1)}),$("#page_reset").click(function(){$(".help-block").addClass("hidden"),$(".has-error").removeClass("has-error"),$("#page_submit").prop("disabled",!1),d()}),$("#enable_cc").click(function(){ccstatus?n():i(),ccstatus=!ccstatus}),$(".has_switch").click(function(){var a=$(this).parent().find(".has_field").prop("checked");$(this).parent().find(".has_field").prop("checked",!a);var t=$(this).prop("for");$("#"+t).prop("disabled",a);var e=$("#"+t).attr("data-validate");e&&switchInputError(a,t)}),$(".has_field").change(function(){var a=$(this).prop("checked"),t=$(this).parent().find(".has_switch").prop("for");$("#"+t).prop("disabled",!a).focus();var e=$("#"+t).attr("data-validate");e&&switchInputError(a,t)}),$("form").submit(function(){return!1}),$("#add_rule_btn").click(function(){$("#ruleModal").find(".modal-title").html(UI.Add_New_Classification_Rule),$("#ruleModal").find(".help-block").addClass("hidden"),$("#ruleModal").find(".has-error").removeClass("has-error"),$("#rule_form").prop("name","addRuleForm"),resetForm("rule_form"),$("#service_class_down").val(default_class),$("#submit_rule_btn").prop("disabled",!1)}),$("#submit_rule_btn").click(function(){var a=0;return $("#ruleModal").find(".help-block").each(function(){$(this).hasClass("hidden")||(a+=1)}),a?($("#submit_rule_btn").prop("disabled",!0),!1):("addRuleForm"==$("#rule_form").prop("name")?r():e(),void $("#ruleModal").modal("hide"))}),$("#add_class_btn").click(function(){$("#classModal").find(".modal-title").html(UI.Add_New_Service_Class),$("#classModal").find(".help-block").addClass("hidden"),$("#classModal").find(".has-error").removeClass("has-error"),$("#class_form").attr("data-name","addClassForm"),resetForm("class_form"),$("#class_form").find('[name="name"],[name="percent"],[name="minRTT"]').prop("disabled",!1),$("#submit_class_btn").prop("disabled",!0),$("#service_class_name").parent().parent().parent().addClass("has-error"),$("#service_class_name").next(".help-block").removeClass("hidden"),$("#percent_bandwidth").parent().parent().parent().addClass("has-error"),$("#percent_bandwidth").parent().next(".help-block").removeClass("hidden"),$("#rtt_no").prop("checked",!0)}),$("#submit_class_btn").click(function(){var a=0;return $("#classModal").find(".help-block").each(function(){$(this).hasClass("hidden")||(a+=1)}),($("#service_class_name").val().length<=0||$("#percent_bandwidth").val().length<=0)&&(a+=1),a?($("#submit_rule_btn").prop("disabled",!0),!1):("addClassForm"==$("#class_form").attr("data-name")?s():l(),void $("#classModal").modal("hide"))}),$("#target_ip_label").click(function(){o(!1),c()}),$("#has_target_ip").click(function(){o(!0),c()}),$("#ping_limit_label").click(function(){p(!1),c()}),$("#has_ping_limit").click(function(){p(!0),c()}),$("[data-validate]").bind("keyup blur",Validate.checkInput),$("#total_bw").bind("keyup blur",function(){var a=$(this).val();Validate.vaInt(a)||Validate.vaLength(a)?($(this).parent().parent().parent().addClass("has-error"),$(this).parent().parent().parent().find(".help-block").removeClass("hidden")):($(this).parent().parent().parent().removeClass("has-error"),$(this).parent().parent().parent().find(".help-block").addClass("hidden")),c()}),$("#ping_limit").bind("keyup blur",function(){var a=$(this).val();Validate.vaInt(a,1)||Validate.vaLength(a)?($(this).parent().parent().addClass("has-error"),$(this).parent().next(".help-block").removeClass("hidden")):($(this).parent().parent().removeClass("has-error"),$(this).parent().next(".help-block").addClass("hidden")),c()}),$("#target_ip").bind("keyup blur",function(){var a=$(this).val();Validate.vaIP(a)||Validate.vaLength(a)?($(this).parent().parent().addClass("has-error"),$(this).next(".help-block").removeClass("hidden")):($(this).parent().parent().removeClass("has-error"),$(this).next(".help-block").addClass("hidden")),c()})}();