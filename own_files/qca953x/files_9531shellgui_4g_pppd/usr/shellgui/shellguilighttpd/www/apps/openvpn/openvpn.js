function createClientTable(e){for(var t="",n=0;n<e.length;n++){var i="";e[n].subnet_ip&&e[n].subnet_mask&&(i="<br>"+e[n].subnet_ip+"/"+e[n].subnet_mask);var a="/?app=openvpn&action=download_client_key&id="+e[n].id,l='<tr id="'+e[n].id+'"><td>'+e[n].name+"</td><td>"+e[n].ip+i+'</td><td><input type="checkbox" class="enabled_btn" '+(e[n].enabled?"checked":"")+' data-id="'+e[n].id+'"></td><td><a href="'+a+'"><button class="btn btn-default btn-sm download_cer_btn">'+UI.Download+'</button></a></td><td><button data-toggle="modal" data-target="#formModal" data-id="'+e[n].id+'" class="btn btn-default btn-sm edit_client_btn">'+UI.Edit+'</button></td><td><button data-id="'+e[n].id+'" class="btn btn-danger btn-sm del_client_btn">'+UI.Remove+"</button></td></tr>";t+=l}return $("#client_container").empty().append(t),$(".edit_client_btn").click(function(){var e=$(this).attr("data-id");alterFormModal(e)}),$(".del_client_btn").click(function(){var e=$(this).attr("data-id");removeClient(e)}),$(".enabled_btn").click(function(){var e=$(this).attr("data-id"),t=$(this).prop("checked");enabledClient(e,t)}),t}function alterFormModal(e){null!=e?($("#formModalLabel").html("编辑啥子的自己填"),$("#submit_client_btn").html("Save").attr("data-type","edit").attr("data-id",e),setFormData(e)):($("#formModalLabel").html(UI.Configure_A_New_Client_Set_of_Credentials),$("#submit_client_btn").html("Add").attr("data-type","add").attr("data-id",""),setFormData())}function alterSubnet(){var e=$("#cipher").val();"false"==e?$("#subnet_container").addClass("hidden"):$("#subnet_container").removeClass("hidden")}function setTableFromUci(e){var t=e.getAllSectionsOfType(pkg,"allowed_client");t.sort();for(var n=[],i=0;i<t.length;i++){var a={};a.id=e.get(pkg,t[i],"id"),a.name=e.get(pkg,t[i],"name"),a.ip=e.get(pkg,t[i],"ip"),a.remote=e.get(pkg,t[i],"remote"),a.enabled=e.get(pkg,t[i],"enabled"),a.subnet_ip=e.get(pkg,t[i],"subnet_ip"),a.subnet_mask=e.get(pkg,t[i],"subnet_mask"),n.push(a)}createClientTable(n)}function setFormData(e){var t;null!=e?t=getDataFromUci(e):(t={},t.id="",t.name="",t.ip="",t.remote="",t.enabled="",t.subnet_ip="",t.subnet_mask="");var n;n=t.subnet_ip&&t.subnet_mask?"true":"false",$("#client_name").val(t.name),$("#client_ip").val(t.ip),$("#proto").val(t.remote),$("#cipher").val(n),alterSubnet(),"true"==n?($("#subnet_ip").val(t.subnet_ip),$("#subnet_mask").val(t.subnet_mask)):($("#subnet_ip").val(""),$("#subnet_mask").val(""))}function getDataFromUci(e){for(var t=uci.getAllSectionsOfType(pkg,"allowed_client"),n={},i=0;i<t.length;i++)uci.get(pkg,t[i],"id")==e&&(n.id=uci.get(pkg,t[i],"id"),n.name=uci.get(pkg,t[i],"name"),n.ip=uci.get(pkg,t[i],"ip"),n.remote=uci.get(pkg,t[i],"remote"),n.enabled=uci.get(pkg,t[i],"enabled"),n.subnet_ip=uci.get(pkg,t[i],"subnet_ip"),n.subnet_mask=uci.get(pkg,t[i],"subnet_mask"));return n}function setUciFromData(e){uci.set(pkg,e.id,"","allowed_client"),uci.set(pkg,e.id,"id",e.id),uci.set(pkg,e.id,"name",e.name),uci.set(pkg,e.id,"ip",e.ip),uci.set(pkg,e.id,"remote",e.remote),uci.set(pkg,e.id,"subnet_mask",e.subnet_mask),uci.set(pkg,e.id,"subnet_ip",e.subnet_ip),uci.set(pkg,e.id,"enabled",e.enabled)}function addNewClient(){var e="client"+(parseInt($("#client_container>tr:last").prop("id").replace("client",""))+1),t={};t.id=e,t.name=$("#client_name").val(),t.ip=$("#client_ip").val(),t.remote=$("#proto").val(),t.subnet_ip=$("#subnet_ip").val(),t.subnet_mask=$("#subnet_mask").val();var n=$("#cipher").val();t.enabled=!0,"false"==n&&(t.subnet_ip="",t.subnet_mask="");var i=validateClient(t);if(0==i.length){$("#formModal").modal("hide");var a={app:"openvpn",action:"add_client",data:t};$.post("/",a,function(e){Ha.showNotify(e),e.status||(setUciFromData(t),setTableFromUci(uci))},"json")}else Ha.showNotify({status:1,msg:i[0]+"<br>"+UI.Add_new_client_fail+"."})}function editClient(e){var t={};t.id=e,t.name=$("#client_name").val(),t.ip=$("#client_ip").val(),t.remote=$("#proto").val(),t.subnet_ip=$("#subnet_ip").val(),t.subnet_mask=$("#subnet_mask").val();var n=$("#cipher").val();t.enabled=$("#"+e).find('[type="checkbox"]').prop("checked"),"false"==n&&(t.subnet_ip="",t.subnet_mask="");var i=validateClient(t);if(0==i.length){$("#formModal").modal("hide");var a={app:"openvpn",action:"edit_client",data:t};$.post("/",a,function(n){if(Ha.showNotify(n),!n.status){var i=uci.getAllSectionsOfType(pkg,"allowed_client");for(sectionIndex=0;sectionIndex<i.length;sectionIndex++)uci.get(pkg,i[sectionIndex],"id")==e&&uci.removeSection(pkg,i[sectionIndex]);setUciFromData(t),setTableFromUci(uci)}},"json")}else Ha.showNotify({status:1,msg:i[0]+"<br>"+UI.Add_new_client_fail+"."})}function removeClient(e){var t={app:"openvpn",action:"remove_client",id:e};$.post("/",t,function(t){if(Ha.showNotify(t),!t.status){var n=uci.getAllSectionsOfType(pkg,"allowed_client");for(sectionIndex=0;sectionIndex<n.length;sectionIndex++)uci.get(pkg,n[sectionIndex],"id")==e&&uci.removeSection(pkg,n[sectionIndex]);setTableFromUci(uci)}},"json")}function enabledClient(e,t){var n={app:"openvpn",action:"enabled_client",id:e,enabled:t};$.post("/",n,function(n){Ha.showNotify(n),n.status?$("#"+e).find('[type="checkbox"]').prop("checked",!t):(uci.set(pkg,e,"enabled",""+t),setTableFromUci(uci))},"json")}function validateClient(e){var t=[];if(""==e.name)return t.push(UI.Client_Name_filed_Empty+"."),t;if(validateIP(e.ip))return t.push(UI.IPaddr_is_invalid+"."),t;if(""!=e.subnet_ip&&""!=e.subnet_mask){if(validateIP(e.subnet_ip))return t.push(UI.Subnet_IP_is_invalid+"."),t;if(validateIP(e.subnet_mask))return t.push(UI.Subnet_mask_is_invalid+"."),t}return t}function validateIP(e){var t=0;if("0.0.0.0"==e)t=1;else if("255.255.255.255"==e)t=2;else{var n=e.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/);if(null==n)t=5;else for(field=1;field<=4;field++)n[field]>255&&(t=4),255==n[field]&&4==field&&(t=3)}return t}var uci=uciOriginal.clone(),pkg="openvpn_uci";setTableFromUci(uciOriginal),$("#set_openvpn_server").submit(function(e){e.preventDefault();var t="app=openvpn&action=set_openvpn_server&"+$(this).serialize();Ha.disableForm("set_openvpn_server"),Ha.ajax("/","json",t,"post","set_openvpn_server",Ha.showNotify,1)}),$("#set_openvpn_client").submit(function(e){e.preventDefault();var t="app=openvpn&action=set_openvpn_client&"+$(this).serialize();Ha.disableForm("set_openvpn_client"),Ha.ajax("/","json",t,"post","set_openvpn_client",Ha.showNotify,1)}),$("#cipher").change(alterSubnet),$("#add_new_client_btn").click(function(){alterFormModal()}),$("#submit_client_btn").click(function(){var e=$(this).attr("data-id"),t=$(this).attr("data-type");"edit"==t?editClient(e):addNewClient()});