function initPage(){submit_switchs={};for(key in switchs){$("#add_btn_"+key).unbind("click");var t=switchs[key];setSwitch(key,t),submit_switchs[key]=[];for(var s=0;s<switchs[key].vlans.length;s++){var e=$.extend({},switchs[key].vlans[s]);submit_switchs[key].push(e)}}$(".help-block").addClass("hidden")}function setSwitch(t,s){setPortTr(t,s),setPortIcon(t,s),setVlanTr(t,s),$("#add_btn_td_"+t).prop("colspan",s.portsCount+2),$("#add_btn_"+t).bind("click",function(){setVlan(getNewId(t),"",new_config,t,s),submit_switchs[t].push({config:new_config,vlan_id:getNewId(t),ports:""}),Ha.setFooterPosition(),new_config--}),setInterval(function(){setPortIconData(t,s)},5e3)}function getNewId(t){for(var s=1,e=submit_switchs[t],n=0;n<e.length;n++)s=Math.max(s,e[n].vlan_id);return s+=1}function getNewPorts(t){for(var s=[],e=switchs[t].portsCount,n=0;n<e;n++)s.push(n);return s.join(" ")}function submitPage(){console.log(submit_switchs);var t={app:"vlan",action:"set_vlan",data:submit_switchs};$.post("/",t,function(t){if(Ha.showNotify(t),!t.status){switchs=t.switchs;for(key in switchs){$("#add_btn_"+key).unbind("click");var s=switchs[key];setSwitch(key,s)}}},"json")}function setPortTr(t,s){for(var e='<th  class="text-center">Vlan ID</th>',n=0;n<s.portsCount;n++){var i;i=n==s.cpuPort?'<th class="text-center">CPU</th>':'<th class="text-center">Port'+n+"</th>",e+=i}$("#port_tr_"+t).empty().append(e),$("#port_tr_"+t).append("<th></th>"),Ha.setFooterPosition()}function setPortIcon(t,s){var e="http://www.w3.org/2000/svg";$("#ports_status_tr_"+t).empty().append("<td></td>"),$.post("/","app=vlan&action=port_status&switch="+t,function(s){for(key in s){var n=document.createElementNS(e,"svg");n.setAttribute("width",30),n.setAttribute("height",30);var i=document.createElementNS(e,"path");n.appendChild(i),i.setAttribute("d","M28.063,15.377V2.312c0,0,0-1.621-1.621-1.621H2.313c-1.622,0-1.622,1.622-1.622,1.622v13.127c0,0,0,1.607,1.622,1.621l3.739-0.044l3.208,0.046l0.037,4.626l0,0c0,0-0.011,1.621,1.622,1.621h6.918c0,0,1.574,0,1.621-1.621l0.037-4.626l3.207-0.046h3.74C26.441,17.017,28.063,17,28.063,15.377z"),i.setAttribute("stroke-width",2),i.setAttribute("data-id",key);var a="up"==s[key].link,r=a?s[key].speed+"<br>"+s[key].duplex:"unLinked",o=$("<td></td>"),d="up"==s[key].link?"svg_fill":"svg_stroke",l="up"==s[key].link?"":"none",c="up"==s[key].link?"none":"";i.setAttribute("class",d),i.setAttribute("fill",l),i.setAttribute("stroke",c),o.get(0).appendChild(n),o.append('<br><span data-status="'+key+'">'+r+"</span>"),$("#ports_status_tr_"+t).append(o)}return $("#ports_status_tr_"+t).append("<td></td>"),!0},"json"),Ha.setFooterPosition()}function setPortIconData(t,s){$.post("/","app=vlan&action=port_status&switch="+t,function(s){$("#ports_status_tr_"+t).find(".svg_fill").each(function(){$(this).removeClass("svg_fill").addClass("svg_stroke"),$(this).get(0).setAttribute("fill","none")}),setTimeout(function(){for(key in s){var e="up"==s[key].link,n=e?s[key].speed+"<br>"+s[key].duplex:"unLinked",i="up"==s[key].link?"svg_fill":"svg_stroke",a="up"==s[key].link?"":"none",r="up"==s[key].link?"none":"",o=$("#ports_status_tr_"+t).find('[data-id="'+key+'"]').get(0);o.setAttribute("fill",a),o.setAttribute("stroke",r),o.setAttribute("class",i),$("#ports_status_tr_"+t).find('[data-status="'+key+'"]').html(n)}},1e3)},"json")}function setVlanTr(t,s){for(var e=s.vlans,n=0;n<e.length;n++){var i=e[n].ports,a=e[n].vlan_id,r=e[n].config;$("#vlan_trs_"+t).empty(),setVlan(a,i,r,t,s)}Ha.setFooterPosition()}function setVlan(t,s,e,n,i){var a='<tr data-config="'+e+'"><td><input type="number" min="1" class="vlan_input error" size="6" value="'+t+'"></td></tr>';a=$(a),s=" "+s+" ";for(var r=0;r<i.portsCount;r++){var o='<td><select><option value="off">off</option><option value="tag">tag</option><option value="untag">untag</option></select></td>';o=$(o);var d="[^0-9]"+r+"[^0-9]t?",l=new RegExp(d);l.test(s)?"t"==s.charAt(s.indexOf(r)+1)?o.find("select").val("tag"):o.find("select").val("untag"):o.find("select").val("off"),a.append(o)}var c=$('<td><button class="btn btn-xs btn-danger">Remove</button></td>');a.append(c),$("#vlan_trs_"+n).append(a);var u=0;a.find("select").each(function(t){var s=$(this).val();"off"!=s&&(u+=1),$(this).change(function(){var s=$(this).val(),e=$(this).parent().parent().attr("data-config"),i=checkSelect(e);i?(a.find("select").addClass("error"),console.log(n),$("#add_btn_td_"+n).find(".port-help").removeClass("hidden")):(a.find("select").removeClass("error"),$("#add_btn_td_"+n).find(".port-help").addClass("hidden")),setPorts(n,e,t,s),disableBtn()})}),u?(a.find("select").removeClass("error"),$("#add_btn_td_"+n).find(".port-help").addClass("hidden")):(a.find("select").addClass("error"),$("#add_btn_td_"+n).find(".port-help").removeClass("hidden")),""!=t&&a.find("input").removeClass("error"),disableBtn(),c.find("button").click(function(){$(this).parent().parent().remove();for(var t=$(this).parent().parent().attr("data-config"),s=0;s<submit_switchs[n].length;s++)t==submit_switchs[n][s].config&&submit_switchs[n].splice(s,1);disableBtn()}),$(".vlan_input").bind("keyup",function(){var t=$(this).val(),s=$(this).parent().parent().attr("data-config");if(Validate.vaInt(t,1))$(this).addClass("error"),$("#add_btn_td_"+n).find(".id-help").removeClass("hidden");else if(uniqueId(t,s,n)){$(this).removeClass("error"),$("#add_btn_td_"+n).find(".id-help").addClass("hidden");for(var e=0;e<submit_switchs[n].length;e++)s==submit_switchs[n][e].config&&(submit_switchs[n][e].vlan_id=parseInt(t))}else $(this).addClass("error"),$("#add_btn_td_"+n).find(".id-help").removeClass("hidden");disableBtn()}),$(".vlan_input").bind("blur",function(){var t=$(this).val(),s=$(this).parent().parent().attr("data-config");if(Validate.vaInt(t,1)){for(var e=0;e<submit_switchs[n].length;e++)s==submit_switchs[n][e].config&&$(this).val(submit_switchs[n][e].vlan_id);$(this).removeClass("error"),$("#add_btn_td_"+n).find(".id-help").addClass("hidden")}else if(uniqueId(t,s,n)){$(this).removeClass("error"),$("#add_btn_td_"+n).find(".id-help").addClass("hidden");for(var e=0;e<submit_switchs[n].length;e++)s==submit_switchs[n][e].config&&(submit_switchs[n][e].vlan_id=parseInt(t))}else{for(var e=0;e<submit_switchs[n].length;e++)s==submit_switchs[n][e].config&&$(this).val(submit_switchs[n][e].vlan_id);$(this).removeClass("error"),$("#add_btn_td_"+n).find(".id-help").addClass("hidden")}disableBtn()}),Ha.setFooterPosition()}function checkSelect(t){var s=0;return $('[data-config="'+t+'"]').find("select").each(function(){"off"!==$(this).val()&&(s+=1)}),!s}function uniqueId(t,s,e){for(var n=0;n<submit_switchs[e].length;n++)if(t==submit_switchs[e][n].vlan_id&&s!=submit_switchs[e][n].config)return!1;return!0}function disableBtn(){var t=0;$(".vlan_input,select").each(function(){$(this).hasClass("error")&&(t+=1)}),t?$("#submit_page_btn").prop("disabled",!0):($("#submit_page_btn").prop("disabled",!1),$(".help-block").addClass("hidden"))}function setPorts(t,s,e,n){for(var i=submit_switchs[t],a=0;a<i.length;a++)s==i[a].config&&(submit_switchs[t][a].ports=setPortsStr(n,e,i[a].ports))}function setPortsStr(t,s,e){e=" "+e+" ";var n="[^0-9]"+s+"[^0-9]t?",i=new RegExp(n);i.test(e)?e.indexOf(" "+s+"t ")>=0?"off"==t?e=e.replace(" "+s+"t "," "):"tag"==t?e=e:"untag"==t&&(e=e.replace(" "+s+"t "," "+s)):"off"==t?e=e.replace(" "+s+" "," "):"tag"==t?e=e.replace(" "+s+" "," "+s+"t "):"untag"==t&&(e=e):"off"==t?e=e:"tag"==t?e=e+" "+s+"t ":"untag"==t&&(e=e+" "+s+" "),e=$.trim(e),e=e.split(" ");for(var a=0;a<e.length;a++)e[a]=$.trim(e[a]),""==e[a]&&e.splice(a,1);return e=e.sort(function(t,s){return parseInt(t)-parseInt(s)}),e.join(" ")}var submit_switchs={};initPage(),$("#submit_page_btn").click(submitPage),$("#reset_page_btn").click(initPage);var new_config=-1;